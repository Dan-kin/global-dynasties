const UI = {
  zh: {
    "document.title": "Global Dynasties",
    "app.title": "Global Dynasties",
    "app.subtitle": "全球王朝对照",
    "nav.searchLabel": "搜索",
    "nav.searchPlaceholder": "搜索国家、朝代或事件",
    "nav.yearJumpLabel": "年份跳转",
    "nav.yearJumpPlaceholder": "例如 1200",
    "nav.jump": "跳转",
    "hero.kicker": "世界同期纵览",
    "hero.title": "默认纵览 + 无限下拉，快速看同一时期的全球格局",
    "hero.desc": "按世纪展示亚洲、欧洲、非洲、美洲与大洋洲的主要政权。可随时切换语言、筛选国家或输入年份查看同期信息。",
    "hero.start": "开始浏览",
    "hero.period.classical": "古典时代",
    "hero.period.medieval": "中世纪",
    "hero.period.earlyModern": "早期近代",
    "hero.period.modern": "现代",
    "filter.region": "洲",
    "filter.country": "国家",
    "filter.dynasty": "朝代 / 政权",
    "filter.year": "年份",
    "filter.yearPlaceholder": "例如 1279",
    "filter.reset": "重置",
    "filter.allRegions": "全部洲",
    "filter.allCountries": "全部国家",
    "filter.allDynasties": "全部朝代",
    "timeline.loading": "正在加载更多时间段...",
    "timeline.end": "已到达当前筛选下的末尾",
    "timeline.yearFocus": "已定位到目标年份附近",
    "timeline.empty": "没有找到匹配结果，请调整筛选条件。",
    "timeline.noRecord": "暂无记录",
    "timeline.records": "条同期记录",
    "card.viewAll": "查看全部 {count}",
    "card.collapse": "收起",
    "detail.concurrent": "同期其他地区",
    "detail.sourceHint": "本页来源以 Encyclopaedia Britannica 为主；含“传统/传说”标签的数据请与考古和一手文献交叉核对。",
    "detail.none": "当前朝代时间段内暂无其他已收录政权",
    "detail.country": "国家",
    "detail.region": "洲别",
    "detail.period": "时间范围",
    "detail.focusYear": "同期计算年份",
    "detail.evidence": "证据等级",
    "detail.sources": "出处",
    "detail.overlap": "重叠区间",
    "detail.includesFocus": "包含焦点年",
    "detail.countryCount": "{count}个国家",
    "detail.focusYearHelp": "焦点年：用于计算“同期”对比的参考年份。未输入年份时，默认取当前朝代时间段中点。",
    "detail.evidenceHelp": "证据等级：表示该时间划分的史料确定程度（高/中/传统/传说）。",
    "detail.overlapHelp": "重叠区间：该政权与当前朝代在时间上实际同时存在的年份范围。",
    "glossary.title": "术语说明（点此展开）",
    "glossary.intro": "以下术语会在筛选面板与右侧详情中反复出现：",
    "glossary.focusYearTerm": "焦点年",
    "glossary.focusYearDesc": "用于定位和比较“同期”关系的参考年份。若不手动输入，系统会自动取当前政权区间中点。",
    "glossary.overlapTerm": "重叠区间",
    "glossary.overlapDesc": "两个政权在时间上真正同时存在的年份段，不是各自完整统治期。",
    "glossary.evidenceTerm": "证据等级",
    "glossary.evidenceDesc": "用于提示时间划分可信度：高（主流共识）、中（概括阶段）、传统（有争议）、传说（未确证）。",
    "glossary.concurrentTerm": "同期其他地区",
    "glossary.concurrentDesc": "按“洲 → 国家 → 政权”分组列出与当前政权时间段重叠的全部记录。",
    "detail.close": "关闭详情",
    "confidence.high": "高（主流学术共识）",
    "confidence.medium": "中（概括性时期）",
    "confidence.traditional": "传统纪年（仍有争议）",
    "confidence.legendary": "传说纪年（非确证史年）",
    "region.asia": "亚洲",
    "region.europe": "欧洲",
    "region.africa": "非洲",
    "region.americas": "美洲",
    "region.oceania": "大洋洲",
    "era.bce": "公元前",
    "era.ce": "公元"
  },
  en: {
    "document.title": "Global Dynasties",
    "app.title": "Global Dynasties",
    "app.subtitle": "Global Dynasties",
    "nav.searchLabel": "Search",
    "nav.searchPlaceholder": "Search country, dynasty, or event",
    "nav.yearJumpLabel": "Year jump",
    "nav.yearJumpPlaceholder": "e.g. 1200",
    "nav.jump": "Jump",
    "hero.kicker": "Global Synchronous View",
    "hero.title": "Default overview + infinite scroll for world timelines",
    "hero.desc": "Browse major polities by century across Asia, Europe, Africa, the Americas, and Oceania. Switch language, filter countries, or enter a year to inspect the same moment globally.",
    "hero.start": "Start Browsing",
    "hero.period.classical": "Classical Era",
    "hero.period.medieval": "Middle Ages",
    "hero.period.earlyModern": "Early Modern",
    "hero.period.modern": "Modern Age",
    "filter.region": "Region",
    "filter.country": "Country",
    "filter.dynasty": "Dynasty / Polity",
    "filter.year": "Year",
    "filter.yearPlaceholder": "e.g. 1279",
    "filter.reset": "Reset",
    "filter.allRegions": "All regions",
    "filter.allCountries": "All countries",
    "filter.allDynasties": "All dynasties",
    "timeline.loading": "Loading more periods...",
    "timeline.end": "End of results for current filters",
    "timeline.yearFocus": "Focused near the selected year",
    "timeline.empty": "No matching records. Try broader filters.",
    "timeline.noRecord": "No records",
    "timeline.records": "concurrent records",
    "card.viewAll": "View all {count}",
    "card.collapse": "Collapse",
    "detail.concurrent": "Other regions at the same time",
    "detail.sourceHint": "Sources are primarily Encyclopaedia Britannica; entries marked traditional/legendary should be cross-checked with archaeological and primary research.",
    "detail.none": "No other curated polities overlap this period",
    "detail.country": "Country",
    "detail.region": "Region",
    "detail.period": "Period",
    "detail.focusYear": "Computed Year",
    "detail.evidence": "Evidence Level",
    "detail.sources": "Sources",
    "detail.overlap": "Overlap",
    "detail.includesFocus": "Includes focus year",
    "detail.countryCount": "{count} countries",
    "detail.focusYearHelp": "Computed year: the reference year used for contemporaneous comparison. If empty, the midpoint of the selected polity period is used.",
    "detail.evidenceHelp": "Evidence level: indicates how firmly the periodization is supported (high/medium/traditional/legendary).",
    "detail.overlapHelp": "Overlap: the actual years when the listed polity and the selected polity coexisted.",
    "glossary.title": "Term Guide (Expand)",
    "glossary.intro": "These terms appear repeatedly in filters and the detail drawer:",
    "glossary.focusYearTerm": "Computed Year",
    "glossary.focusYearDesc": "Reference year used to compare contemporaries. If you do not enter one, the system uses the midpoint of the selected period.",
    "glossary.overlapTerm": "Overlap",
    "glossary.overlapDesc": "The true overlapping years between two polities, not their full independent ranges.",
    "glossary.evidenceTerm": "Evidence Level",
    "glossary.evidenceDesc": "A confidence cue for periodization: high, medium, traditional (debated), or legendary (not firmly dated).",
    "glossary.concurrentTerm": "Other Regions at the Same Time",
    "glossary.concurrentDesc": "Shown as Region -> Country -> Polity, listing all entries that overlap the selected polity period.",
    "detail.close": "Close details",
    "confidence.high": "High (mainstream consensus)",
    "confidence.medium": "Medium (broad periodization)",
    "confidence.traditional": "Traditional chronology (debated)",
    "confidence.legendary": "Legendary chronology (not firm dates)",
    "region.asia": "Asia",
    "region.europe": "Europe",
    "region.africa": "Africa",
    "region.americas": "Americas",
    "region.oceania": "Oceania",
    "era.bce": "BCE",
    "era.ce": "CE"
  },
  fr: {
    "document.title": "Global Dynasties",
    "app.title": "Global Dynasties",
    "app.subtitle": "Dynasties Mondiales",
    "nav.searchLabel": "Recherche",
    "nav.searchPlaceholder": "Rechercher pays, dynastie ou événement",
    "nav.yearJumpLabel": "Aller à l'année",
    "nav.yearJumpPlaceholder": "ex. 1200",
    "nav.jump": "Aller",
    "hero.kicker": "Vue Synchrone Mondiale",
    "hero.title": "Vue d'ensemble par défaut + défilement infini",
    "hero.desc": "Parcourez les grands pouvoirs par siècle en Asie, Europe, Afrique, Amériques et Océanie. Changez la langue, filtrez les pays ou saisissez une année pour comparer le même moment historique.",
    "hero.start": "Commencer",
    "hero.period.classical": "Antiquité",
    "hero.period.medieval": "Moyen Âge",
    "hero.period.earlyModern": "Époque moderne",
    "hero.period.modern": "Époque contemporaine",
    "filter.region": "Région",
    "filter.country": "Pays",
    "filter.dynasty": "Dynastie / pouvoir",
    "filter.year": "Année",
    "filter.yearPlaceholder": "ex. 1279",
    "filter.reset": "Réinitialiser",
    "filter.allRegions": "Toutes les régions",
    "filter.allCountries": "Tous les pays",
    "filter.allDynasties": "Toutes les dynasties",
    "timeline.loading": "Chargement des périodes...",
    "timeline.end": "Fin des résultats pour ces filtres",
    "timeline.yearFocus": "Affichage centré autour de l'année",
    "timeline.empty": "Aucun résultat. Essayez des filtres plus larges.",
    "timeline.noRecord": "Aucun enregistrement",
    "timeline.records": "entrées synchrones",
    "card.viewAll": "Voir tout ({count})",
    "card.collapse": "Réduire",
    "detail.concurrent": "Autres régions au même moment",
    "detail.sourceHint": "Les sources proviennent surtout d'Encyclopaedia Britannica; les entrées traditionnelles/légendaires doivent être recoupées avec des travaux archéologiques et des sources primaires.",
    "detail.none": "Aucun autre pouvoir recensé ne chevauche cette période",
    "detail.country": "Pays",
    "detail.region": "Région",
    "detail.period": "Période",
    "detail.focusYear": "Année de calcul",
    "detail.evidence": "Niveau de preuve",
    "detail.sources": "Sources",
    "detail.overlap": "Chevauchement",
    "detail.includesFocus": "Inclut l'année cible",
    "detail.countryCount": "{count} pays",
    "detail.focusYearHelp": "Année de calcul : année de référence pour comparer les contemporains. Si elle est vide, le milieu de la période sélectionnée est utilisé.",
    "detail.evidenceHelp": "Niveau de preuve : indique le degré de solidité de la périodisation (élevé/moyen/traditionnel/légendaire).",
    "detail.overlapHelp": "Chevauchement : années où le pouvoir listé et le pouvoir sélectionné coexistent réellement.",
    "glossary.title": "Guide des termes (Déplier)",
    "glossary.intro": "Ces termes reviennent souvent dans les filtres et le panneau de détail :",
    "glossary.focusYearTerm": "Année de calcul",
    "glossary.focusYearDesc": "Année de référence pour comparer les contemporains. Sans saisie manuelle, le système prend le milieu de la période sélectionnée.",
    "glossary.overlapTerm": "Chevauchement",
    "glossary.overlapDesc": "Années de coexistence réelle entre deux pouvoirs, et non leurs périodes complètes prises séparément.",
    "glossary.evidenceTerm": "Niveau de preuve",
    "glossary.evidenceDesc": "Indication de confiance : élevé, moyen, traditionnel (discuté) ou légendaire (non fermement daté).",
    "glossary.concurrentTerm": "Autres régions au même moment",
    "glossary.concurrentDesc": "Présenté en Région -> Pays -> Pouvoir, avec toutes les entrées qui chevauchent la période du pouvoir sélectionné.",
    "detail.close": "Fermer",
    "confidence.high": "Élevé (consensus académique)",
    "confidence.medium": "Moyen (périodisation large)",
    "confidence.traditional": "Chronologie traditionnelle (discutée)",
    "confidence.legendary": "Chronologie légendaire (non datée avec certitude)",
    "region.asia": "Asie",
    "region.europe": "Europe",
    "region.africa": "Afrique",
    "region.americas": "Amériques",
    "region.oceania": "Océanie",
    "era.bce": "av. J.-C.",
    "era.ce": "ap. J.-C."
  }
};

const REGION_ORDER = ["asia", "europe", "africa", "americas", "oceania"];
const ERA_MIN = -10000;
const ERA_MAX = 2100;
const ERA_SPAN = 100;
const DEFAULT_LOAD = 7;

const COUNTRIES = {
  CN: { region: "asia", names: { zh: "中国", en: "China", fr: "Chine" } },
  JP: { region: "asia", names: { zh: "日本", en: "Japan", fr: "Japon" } },
  KR: { region: "asia", names: { zh: "朝鲜半岛", en: "Korea", fr: "Corée" } },
  IN: { region: "asia", names: { zh: "印度", en: "India", fr: "Inde" } },
  IR: { region: "asia", names: { zh: "伊朗", en: "Iran", fr: "Iran" } },
  TR: { region: "asia", names: { zh: "土耳其", en: "Turkey", fr: "Turquie" } },
  RU: { region: "europe", names: { zh: "俄罗斯", en: "Russia", fr: "Russie" } },
  FR: { region: "europe", names: { zh: "法国", en: "France", fr: "France" } },
  GB: { region: "europe", names: { zh: "英国", en: "United Kingdom", fr: "Royaume-Uni" } },
  DE: { region: "europe", names: { zh: "德国", en: "Germany", fr: "Allemagne" } },
  IT: { region: "europe", names: { zh: "意大利", en: "Italy", fr: "Italie" } },
  EG: { region: "africa", names: { zh: "埃及", en: "Egypt", fr: "Égypte" } },
  ET: { region: "africa", names: { zh: "埃塞俄比亚", en: "Ethiopia", fr: "Éthiopie" } },
  ML: { region: "africa", names: { zh: "马里", en: "Mali", fr: "Mali" } },
  MX: { region: "americas", names: { zh: "墨西哥", en: "Mexico", fr: "Mexique" } },
  PE: { region: "americas", names: { zh: "秘鲁", en: "Peru", fr: "Pérou" } },
  US: { region: "americas", names: { zh: "美国", en: "United States", fr: "États-Unis" } },
  AU: { region: "oceania", names: { zh: "澳大利亚", en: "Australia", fr: "Australie" } },
  NZ: { region: "oceania", names: { zh: "新西兰", en: "New Zealand", fr: "Nouvelle-Zélande" } }
};

const POLITIES = [
  { id: "paleolithic_cn", region: "asia", country: "CN", start: -10000, end: -7001, name: { zh: "中国旧石器时代", en: "China Paleolithic", fr: "Paléolithique en Chine" }, note: { zh: "完整旧石器年代远早于图表起点，当前仅展示至公元前10000。", en: "The full Paleolithic chronology is earlier; this chart displays from 10000 BCE onward.", fr: "La chronologie complète du Paléolithique est plus ancienne; ce graphique commence ici vers 10000 av. J.-C." } },
  { id: "neolithic_cn", region: "asia", country: "CN", start: -7000, end: -2071, name: { zh: "中国新石器时代", en: "China Neolithic period", fr: "Néolithique en Chine" }, note: { zh: "农业、聚落与区域文化体系发展阶段。", en: "Period of agriculture, settlement expansion, and regional cultures." } },
  { id: "yanhuang_cn", region: "asia", country: "CN", start: -2697, end: -2070, name: { zh: "炎黄传说时代", en: "Yan-Huang legendary era", fr: "ère légendaire Yan-Huang" }, note: { zh: "华夏文明早期传说阶段。", en: "Legendary early stage of Huaxia civilization." } },
  { id: "xia_cn", region: "asia", country: "CN", start: -2070, end: -1600, name: { zh: "夏", en: "Xia", fr: "Xia" }, note: { zh: "传统文献中的早期王朝。", en: "An early dynasty in traditional historiography." } },
  { id: "shang_cn", region: "asia", country: "CN", start: -1600, end: -1046, name: { zh: "商", en: "Shang", fr: "Shang" }, note: { zh: "青铜文明与甲骨文时期。", en: "Bronze-age polity with oracle bone inscriptions." } },
  { id: "zhou_cn", region: "asia", country: "CN", start: -1046, end: -256, name: { zh: "周", en: "Zhou", fr: "Zhou" }, note: { zh: "礼制与诸侯体系长期延续。", en: "A long era of ritual order and regional lords." } },
  { id: "late_zhou_cn", region: "asia", country: "CN", start: -255, end: -222, name: { zh: "战国末期", en: "Late Warring States", fr: "fin des Royaumes combattants" }, note: { zh: "诸侯竞争至秦统一前夜。", en: "Final phase of interstate competition before Qin unification." } },
  { id: "qin_cn", region: "asia", country: "CN", start: -221, end: -206, name: { zh: "秦", en: "Qin", fr: "Qin" }, note: { zh: "首次大一统帝国。", en: "The first unified imperial state in China." } },
  { id: "chu_han_cn", region: "asia", country: "CN", start: -205, end: -203, name: { zh: "楚汉相争", en: "Chu-Han contention", fr: "conflit Chu-Han" }, note: { zh: "秦后过渡期，汉朝建立前的政权竞争。", en: "Post-Qin transition marked by rivalry before Han consolidation." } },
  { id: "han_cn", region: "asia", country: "CN", start: -202, end: 220, name: { zh: "汉", en: "Han", fr: "Han" }, note: { zh: "统一帝国制度成熟。", en: "Imperial institutions became highly structured.", fr: "Les institutions impériales se structurent." } },
  { id: "three_kingdoms_cn", region: "asia", country: "CN", start: 220, end: 280, name: { zh: "三国", en: "Three Kingdoms", fr: "Trois Royaumes" }, note: { zh: "分立政权并存。", en: "Competing regimes coexisted across major regions." } },
  { id: "jin_cn", region: "asia", country: "CN", start: 266, end: 420, name: { zh: "晋", en: "Jin", fr: "Jin" }, note: { zh: "短暂统一后再度分裂。", en: "Brief reunification followed by renewed fragmentation." } },
  { id: "southern_northern_cn", region: "asia", country: "CN", start: 420, end: 589, name: { zh: "南北朝", en: "Northern and Southern Dynasties", fr: "Dynasties du Nord et du Sud" }, note: { zh: "南北对峙与制度演变。", en: "Parallel northern and southern courts evolved distinct institutions." } },
  { id: "sui_cn", region: "asia", country: "CN", start: 581, end: 618, name: { zh: "隋", en: "Sui", fr: "Sui" }, note: { zh: "再统一并开启唐代格局。", en: "Reunification that set conditions for the Tang era." } },
  { id: "tang_cn", region: "asia", country: "CN", start: 618, end: 907, name: { zh: "唐", en: "Tang", fr: "Tang" }, note: { zh: "多元文化与丝路交流活跃。", en: "Cosmopolitan culture and Silk Road exchange flourished.", fr: "Culture cosmopolite et échanges sur la route de la soie." } },
  { id: "five_dynasties_cn", region: "asia", country: "CN", start: 907, end: 960, name: { zh: "五代十国", en: "Five Dynasties and Ten Kingdoms", fr: "Cinq Dynasties et Dix Royaumes" }, note: { zh: "分裂过渡期。", en: "A fragmented transitional era." } },
  { id: "song_cn", region: "asia", country: "CN", start: 960, end: 1279, name: { zh: "宋", en: "Song", fr: "Song" }, note: { zh: "城市经济与科技发展显著。", en: "Urban commerce and technology advanced rapidly.", fr: "Le commerce urbain et la technologie progressent." } },
  { id: "yuan_cn", region: "asia", country: "CN", start: 1271, end: 1368, name: { zh: "元", en: "Yuan", fr: "Yuan" }, note: { zh: "横跨欧亚交流网络。", en: "Eurasian connectivity expanded under imperial rule." } },
  { id: "ming_cn", region: "asia", country: "CN", start: 1368, end: 1644, name: { zh: "明", en: "Ming", fr: "Ming" }, note: { zh: "中央集权与海上远航并行。", en: "Strong central bureaucracy and maritime expeditions coexisted." } },
  { id: "qing_cn", region: "asia", country: "CN", start: 1644, end: 1912, name: { zh: "清", en: "Qing", fr: "Qing" }, note: { zh: "疆域广阔，晚期面临全球冲击。", en: "A vast empire facing major global pressures in the late era." } },
  { id: "roc_cn", region: "asia", country: "CN", start: 1912, end: 1949, name: { zh: "中华民国（大陆时期）", en: "Republic of China (mainland)", fr: "République de Chine (continent)" }, note: { zh: "近代国家转型与战争并行。", en: "State-building and conflict proceeded simultaneously." } },
  { id: "prc_cn", region: "asia", country: "CN", start: 1949, end: 2100, name: { zh: "中华人民共和国", en: "People's Republic of China", fr: "République populaire de Chine" }, note: { zh: "工业化与全球经济联系持续深化。", en: "Industrialization and global economic integration deepened." } },

  { id: "jomon_jp", region: "asia", country: "JP", start: -10000, end: -300, name: { zh: "绳文时代", en: "Jomon period", fr: "période Jomon" }, note: { zh: "完整绳文年代可更早；当前图表从公元前10000起算。", en: "The full Jomon chronology can start earlier; this chart begins at 10000 BCE.", fr: "La chronologie complète de Jomon peut commencer plus tôt; ce graphique démarre vers 10000 av. J.-C." } },
  { id: "yayoi_jp", region: "asia", country: "JP", start: -300, end: 300, name: { zh: "弥生时代", en: "Yayoi period", fr: "période Yayoi" }, note: { zh: "稻作扩展与社会分层出现。", en: "Rice agriculture spread and social hierarchies deepened." } },
  { id: "kofun_jp", region: "asia", country: "JP", start: 300, end: 538, name: { zh: "古坟时代", en: "Kofun period", fr: "période Kofun" }, note: { zh: "大和政权形成过程。", en: "Consolidation of early Yamato authority." } },
  { id: "asuka_jp", region: "asia", country: "JP", start: 538, end: 710, name: { zh: "飞鸟时代", en: "Asuka period", fr: "période Asuka" }, note: { zh: "国家制度与律令体系初建。", en: "Early state institutions and legal codes formed." } },
  { id: "nara_jp", region: "asia", country: "JP", start: 710, end: 794, name: { zh: "奈良时代", en: "Nara period", fr: "période Nara" }, note: { zh: "中央集权体制继续发展。", en: "Centralized institutions continued to develop." } },
  { id: "heian_jp", region: "asia", country: "JP", start: 794, end: 1185, name: { zh: "平安时代", en: "Heian period", fr: "période Heian" }, note: { zh: "宫廷文化高度发展。", en: "Court culture reached a high point." } },
  { id: "kamakura_jp", region: "asia", country: "JP", start: 1185, end: 1333, name: { zh: "镰仓幕府", en: "Kamakura shogunate", fr: "shogunat de Kamakura" }, note: { zh: "武家政治确立。", en: "Warrior government became institutionalized." } },
  { id: "kenmu_jp", region: "asia", country: "JP", start: 1334, end: 1335, name: { zh: "建武新政", en: "Kenmu Restoration", fr: "restauration de Kenmu" }, note: { zh: "镰仓与室町之间的短暂过渡期。", en: "Short transition between Kamakura and Muromachi rule." } },
  { id: "muromachi_jp", region: "asia", country: "JP", start: 1336, end: 1573, name: { zh: "室町幕府", en: "Muromachi shogunate", fr: "shogunat Ashikaga" }, note: { zh: "地区权力竞争加剧。", en: "Regional power competition intensified." } },
  { id: "sengoku_jp", region: "asia", country: "JP", start: 1574, end: 1602, name: { zh: "战国-安土桃山时期", en: "Sengoku-Azuchi-Momoyama", fr: "époque Sengoku-Azuchi-Momoyama" }, note: { zh: "室町后期到德川前夕的统一过渡。", en: "Unification transition from late Muromachi to Tokugawa rule." } },
  { id: "tokugawa_jp", region: "asia", country: "JP", start: 1603, end: 1868, name: { zh: "德川幕府", en: "Tokugawa shogunate", fr: "shogunat Tokugawa" }, note: { zh: "长期稳定与社会分层并存。", en: "Long stability coexisted with strict social hierarchy." } },
  { id: "meiji_jp", region: "asia", country: "JP", start: 1868, end: 1912, name: { zh: "明治时期", en: "Meiji era", fr: "ère Meiji" }, note: { zh: "快速现代化与制度重塑。", en: "Rapid modernization reshaped institutions." } },
  { id: "taisho_showa_jp", region: "asia", country: "JP", start: 1912, end: 1947, name: { zh: "大正-昭和前期", en: "Taisho to early Showa", fr: "Taisho et début Showa" }, note: { zh: "宪政、战争与体制转折并存。", en: "Constitutional politics and wartime shifts overlapped." } },
  { id: "modern_jp", region: "asia", country: "JP", start: 1947, end: 2100, name: { zh: "现代日本", en: "Modern Japan", fr: "Japon moderne" }, note: { zh: "战后宪政体制延续至今。", en: "Postwar constitutional system continues." } },

  { id: "prehistoric_kr", region: "asia", country: "KR", start: -10000, end: -2334, name: { zh: "朝鲜半岛史前文化阶段", en: "Korean peninsula prehistory", fr: "préhistoire de la péninsule coréenne" }, note: { zh: "古朝鲜形成前的长期史前文化阶段。", en: "Long prehistoric phases before early Korean state formation." } },
  { id: "gojoseon_kr", region: "asia", country: "KR", start: -2333, end: -108, name: { zh: "古朝鲜", en: "Gojoseon", fr: "Gojoseon" }, note: { zh: "半岛早期国家传统源头。", en: "Early state tradition on the Korean peninsula." } },
  { id: "proto_three_kingdoms_kr", region: "asia", country: "KR", start: -107, end: 56, name: { zh: "原三国过渡期", en: "Proto-Three Kingdoms transition", fr: "transition proto-Trois Royaumes" }, note: { zh: "古朝鲜之后到三国时代前的过渡阶段。", en: "Transition between Gojoseon and the Three Kingdoms era." } },
  { id: "three_kingdoms_kr", region: "asia", country: "KR", start: 57, end: 668, name: { zh: "三国时代（高句丽/百济/新罗）", en: "Three Kingdoms of Korea", fr: "Trois Royaumes de Corée" }, note: { zh: "多国并立与文化整合。", en: "Competing kingdoms with evolving cultural synthesis." } },
  { id: "unified_silla_kr", region: "asia", country: "KR", start: 668, end: 935, name: { zh: "统一新罗", en: "Unified Silla", fr: "Silla unifié" }, note: { zh: "半岛统一时期。", en: "A major unification phase on the peninsula." } },
  { id: "goryeo_kr", region: "asia", country: "KR", start: 918, end: 1392, name: { zh: "高丽", en: "Goryeo", fr: "Goryeo" }, note: { zh: "半岛统一与佛教文化繁荣。", en: "Peninsular consolidation and Buddhist culture flourished." } },
  { id: "joseon_kr", region: "asia", country: "KR", start: 1392, end: 1897, name: { zh: "朝鲜王朝", en: "Joseon", fr: "dynastie Joseon" }, note: { zh: "儒家官僚体制长期稳定。", en: "Confucian bureaucratic order lasted for centuries." } },
  { id: "modern_transition_kr", region: "asia", country: "KR", start: 1898, end: 1947, name: { zh: "大韩帝国与殖民过渡期", en: "Korean Empire and colonial transition", fr: "Empire coréen et transition coloniale" }, note: { zh: "王朝末期至二战后重组前的现代过渡阶段。", en: "Modern transition from late monarchy through colonial era to postwar reconfiguration." } },
  { id: "korea_modern", region: "asia", country: "KR", start: 1948, end: 2100, name: { zh: "现代韩国", en: "Modern Korea", fr: "Corée moderne" }, note: { zh: "冷战后区域格局中的关键国家。", en: "A key state in the postwar regional order." } },

  { id: "prehistoric_in", region: "asia", country: "IN", start: -10000, end: -2601, name: { zh: "南亚史前文化阶段", en: "South Asian prehistory", fr: "préhistoire sud-asiatique" }, note: { zh: "农业和聚落形成前后的长期史前阶段。", en: "Long prehistoric phases before and during early settlement development." } },
  { id: "indus_in", region: "asia", country: "IN", start: -2600, end: -1900, name: { zh: "印度河流域文明", en: "Indus Valley Civilization", fr: "civilisation de l'Indus" }, note: { zh: "南亚早期城市文明体系。", en: "Early urban civilization in South Asia." } },
  { id: "late_harappan_in", region: "asia", country: "IN", start: -1899, end: -1501, name: { zh: "后哈拉帕过渡期", en: "Late Harappan transition", fr: "transition harappéenne tardive" }, note: { zh: "印度河文明之后到吠陀时期前的过渡阶段。", en: "Transition after the Indus urban phase and before the Vedic period." } },
  { id: "vedic_in", region: "asia", country: "IN", start: -1500, end: -600, name: { zh: "吠陀时代", en: "Vedic period", fr: "période védique" }, note: { zh: "早期宗教与社会结构形成。", en: "Foundational religious and social formations emerged." } },
  { id: "mahajanapada_in", region: "asia", country: "IN", start: -600, end: -322, name: { zh: "列国时代", en: "Mahajanapada era", fr: "ère des Mahajanapadas" }, note: { zh: "多国并立的古典前夜。", en: "An era of multiple major polities." } },
  { id: "maurya_in", region: "asia", country: "IN", start: -322, end: -185, name: { zh: "孔雀王朝", en: "Maurya Empire", fr: "Empire maurya" }, note: { zh: "早期次大陆大一统帝国。", en: "One of the first large imperial unifications in the subcontinent." } },
  { id: "post_maurya_in", region: "asia", country: "IN", start: -185, end: 320, name: { zh: "后孔雀诸国", en: "Post-Mauryan polities", fr: "pouvoirs post-maurya" }, note: { zh: "多王朝并行发展。", en: "Multiple dynasties and regional powers coexisted." } },
  { id: "gupta_in", region: "asia", country: "IN", start: 320, end: 550, name: { zh: "笈多王朝", en: "Gupta Empire", fr: "Empire Gupta" }, note: { zh: "古典文化与知识体系兴盛。", en: "Classical cultural and scholarly traditions flourished." } },
  { id: "regional_kingdoms_in", region: "asia", country: "IN", start: 550, end: 1206, name: { zh: "诸区域王国时期", en: "Regional kingdoms era", fr: "ère des royaumes régionaux" }, note: { zh: "区域政权长期并存。", en: "Long period of regional polities across South Asia." } },
  { id: "delhi_in", region: "asia", country: "IN", start: 1206, end: 1526, name: { zh: "德里苏丹国", en: "Delhi Sultanate", fr: "sultanat de Delhi" }, note: { zh: "北印度多王朝交替时期。", en: "A period of shifting polities across North India." } },
  { id: "mughal_in", region: "asia", country: "IN", start: 1526, end: 1857, name: { zh: "莫卧儿帝国", en: "Mughal Empire", fr: "Empire moghol" }, note: { zh: "形成跨区域帝国治理。", en: "A major transregional imperial administration emerged." } },
  { id: "raj_in", region: "asia", country: "IN", start: 1858, end: 1947, name: { zh: "英属印度", en: "British Raj", fr: "Raj britannique" }, note: { zh: "殖民治理与反殖运动并行。", en: "Colonial administration and anti-colonial movements coexisted." } },
  { id: "dominion_in", region: "asia", country: "IN", start: 1948, end: 1949, name: { zh: "印度自治领", en: "Dominion of India", fr: "Dominion de l'Inde" }, note: { zh: "独立初期向共和国过渡的阶段。", en: "Early post-independence transition toward the republican constitution." } },
  { id: "india_republic", region: "asia", country: "IN", start: 1950, end: 2100, name: { zh: "印度共和国", en: "Republic of India", fr: "République de l'Inde" }, note: { zh: "联邦民主框架延续。", en: "A federal democratic framework continues." } },

  { id: "prehistoric_ir", region: "asia", country: "IR", start: -10000, end: -2701, name: { zh: "伊朗史前文化阶段", en: "Iranian prehistory", fr: "préhistoire de l'Iran" }, note: { zh: "伊朗高原农业与聚落发展的早期阶段。", en: "Early agricultural and settlement phases on the Iranian plateau." } },
  { id: "elam_ir", region: "asia", country: "IR", start: -2700, end: -539, name: { zh: "埃兰诸政权", en: "Elamite polities", fr: "pouvoirs élamites" }, note: { zh: "伊朗高原早期文明与城邦体系。", en: "Early state formations on the Iranian plateau." } },
  { id: "median_ir", region: "asia", country: "IR", start: -678, end: -550, name: { zh: "米底王国", en: "Median Kingdom", fr: "royaume mède" }, note: { zh: "阿契美尼德之前的重要王国。", en: "A major predecessor state before Achaemenid unification." } },
  { id: "achaemenid_ir", region: "asia", country: "IR", start: -550, end: -330, name: { zh: "阿契美尼德帝国", en: "Achaemenid Empire", fr: "Empire achéménide" }, note: { zh: "古代西亚大型帝国。", en: "A major imperial system in ancient West Asia." } },
  { id: "seleucid_ir", region: "asia", country: "IR", start: -329, end: -248, name: { zh: "塞琉古统治时期", en: "Seleucid Iran", fr: "Iran séleucide" }, note: { zh: "阿契美尼德之后到安息兴起前的希腊化阶段。", en: "Hellenistic phase between Achaemenid rule and Parthian ascendancy." } },
  { id: "parthian_ir", region: "asia", country: "IR", start: -247, end: 224, name: { zh: "安息帝国", en: "Parthian Empire", fr: "Empire parthe" }, note: { zh: "连接地中海与中亚贸易。", en: "A key intermediary empire linking Mediterranean and Central Asia." } },
  { id: "sasanian_ir", region: "asia", country: "IR", start: 224, end: 651, name: { zh: "萨珊帝国", en: "Sasanian Empire", fr: "Empire sassanide" }, note: { zh: "与罗马/拜占庭长期竞争。", en: "Long strategic rivalry with Rome and Byzantium." } },
  { id: "islamic_dynasties_ir", region: "asia", country: "IR", start: 652, end: 1500, name: { zh: "伊朗伊斯兰王朝时期", en: "Islamic dynasties in Iran", fr: "dynasties islamiques d'Iran" }, note: { zh: "后萨珊至萨法维之前的多王朝阶段。", en: "Multi-dynastic era between Sasanian rule and Safavid consolidation." } },
  { id: "safavid_ir", region: "asia", country: "IR", start: 1501, end: 1736, name: { zh: "萨法维王朝", en: "Safavid dynasty", fr: "dynastie safavide" }, note: { zh: "重塑伊朗国家与宗教结构。", en: "State and confessional identity were reconfigured." } },
  { id: "afshar_zand_ir", region: "asia", country: "IR", start: 1737, end: 1788, name: { zh: "阿夫沙尔-赞德时期", en: "Afsharid-Zand period", fr: "période afcharide-zand" }, note: { zh: "萨法维之后、卡扎尔之前的政权过渡。", en: "Transitional dynastic period between Safavid and Qajar rule." } },
  { id: "qajar_ir", region: "asia", country: "IR", start: 1789, end: 1925, name: { zh: "卡扎尔王朝", en: "Qajar dynasty", fr: "dynastie qadjare" }, note: { zh: "近代化压力下的王朝转型。", en: "Dynastic politics under modernization pressures." } },
  { id: "iran_modern", region: "asia", country: "IR", start: 1925, end: 2100, name: { zh: "现代伊朗", en: "Modern Iran", fr: "Iran moderne" }, note: { zh: "现代国家制度持续演变。", en: "Modern state institutions continued to evolve." } },

  { id: "prehistoric_tr", region: "asia", country: "TR", start: -10000, end: -1601, name: { zh: "安纳托利亚史前文化阶段", en: "Anatolian prehistory", fr: "préhistoire anatolienne" }, note: { zh: "安纳托利亚地区早期聚落和文化发展阶段。", en: "Early settlement and cultural development phases in Anatolia." } },
  { id: "hittite_tr", region: "asia", country: "TR", start: -1600, end: -1178, name: { zh: "赫梯帝国", en: "Hittite Empire", fr: "Empire hittite" }, note: { zh: "安纳托利亚青铜时代强权。", en: "A major Bronze Age power in Anatolia." } },
  { id: "anatolian_states_tr", region: "asia", country: "TR", start: -1178, end: -330, name: { zh: "安纳托利亚诸国", en: "Anatolian successor states", fr: "États anatoliens" }, note: { zh: "后赫梯时代多政权并立。", en: "Multiple successor polities after the Hittite era." } },
  { id: "hellenistic_tr", region: "asia", country: "TR", start: -329, end: -130, name: { zh: "希腊化安纳托利亚", en: "Hellenistic Anatolia", fr: "Anatolie hellénistique" }, note: { zh: "亚历山大之后到罗马直接统治前的阶段。", en: "Period from post-Alexandrian rule to direct Roman control." } },
  { id: "roman_anatolia_tr", region: "asia", country: "TR", start: -129, end: 330, name: { zh: "罗马安纳托利亚", en: "Roman Anatolia", fr: "Anatolie romaine" }, note: { zh: "罗马帝国在小亚细亚的统治阶段。", en: "Roman imperial administration across Anatolia." } },
  { id: "byzantine_tr", region: "asia", country: "TR", start: 330, end: 1453, name: { zh: "拜占庭帝国", en: "Byzantine Empire", fr: "Empire byzantin" }, note: { zh: "连接欧亚地中海网络。", en: "A bridge across Mediterranean and Eurasian systems." } },
  { id: "ottoman_tr", region: "asia", country: "TR", start: 1299, end: 1922, name: { zh: "奥斯曼帝国", en: "Ottoman Empire", fr: "Empire ottoman" }, note: { zh: "跨洲帝国长期存在。", en: "A long-lived transcontinental empire." } },
  { id: "turkey_republic", region: "asia", country: "TR", start: 1923, end: 2100, name: { zh: "土耳其共和国", en: "Republic of Turkey", fr: "République de Turquie" }, note: { zh: "现代共和体制建立并延续。", en: "Modern republican institutions were established and sustained." } },

  { id: "prehistoric_it", region: "europe", country: "IT", start: -10000, end: -510, name: { zh: "意大利半岛史前文化阶段", en: "Italian peninsula prehistory", fr: "préhistoire de la péninsule italienne" }, note: { zh: "罗马共和国建立前的史前与早期文明阶段。", en: "Prehistoric and protohistoric phases before the Roman Republic." } },
  { id: "roman_republic_it", region: "europe", country: "IT", start: -509, end: -27, name: { zh: "罗马共和国", en: "Roman Republic", fr: "République romaine" }, note: { zh: "地中海扩张的共和阶段。", en: "Republican phase of Mediterranean expansion." } },
  { id: "roman_it", region: "europe", country: "IT", start: -27, end: 476, name: { zh: "罗马帝国", en: "Roman Empire", fr: "Empire romain" }, note: { zh: "古典地中海核心政体。", en: "Core imperial polity of the classical Mediterranean." } },
  { id: "post_roman_it", region: "europe", country: "IT", start: 477, end: 755, name: { zh: "后罗马意大利过渡期", en: "Post-Roman Italy transition", fr: "transition post-romaine en Italie" }, note: { zh: "西罗马之后到教皇国形成前的多政权阶段。", en: "Multi-polity phase from post-Roman fragmentation to early papal temporal rule." } },
  { id: "papal_it", region: "europe", country: "IT", start: 756, end: 1870, name: { zh: "教皇国", en: "Papal States", fr: "États pontificaux" }, note: { zh: "宗教与世俗权力并存。", en: "Temporal and spiritual authority intersected." } },
  { id: "kingdom_it", region: "europe", country: "IT", start: 1861, end: 1946, name: { zh: "意大利王国", en: "Kingdom of Italy", fr: "Royaume d'Italie" }, note: { zh: "民族国家统一后的王国时期。", en: "Monarchical phase after national unification." } },
  { id: "italy_republic", region: "europe", country: "IT", start: 1946, end: 2100, name: { zh: "意大利共和国", en: "Italian Republic", fr: "République italienne" }, note: { zh: "战后共和政体稳定发展。", en: "Postwar republican institutions stabilized." } },

  { id: "prehistoric_fr", region: "europe", country: "FR", start: -10000, end: -601, name: { zh: "法国史前文化阶段", en: "Prehistoric France", fr: "préhistoire de la France" }, note: { zh: "高卢成形前的史前文化与部落阶段。", en: "Prehistoric cultural phases before historically documented Gaulish polities." } },
  { id: "gaul_fr", region: "europe", country: "FR", start: -600, end: -51, name: { zh: "高卢诸部", en: "Gaulish polities", fr: "pouvoirs gaulois" }, note: { zh: "罗马征服前的高卢政治共同体。", en: "Pre-Roman political formations in Gaul." } },
  { id: "roman_gaul_fr", region: "europe", country: "FR", start: -51, end: 476, name: { zh: "罗马高卢", en: "Roman Gaul", fr: "Gaule romaine" }, note: { zh: "罗马帝国下的行省治理。", en: "Provincial administration under Roman imperial rule." } },
  { id: "late_antiquity_fr", region: "europe", country: "FR", start: 477, end: 480, name: { zh: "高卢晚期过渡", en: "Late Antiquity transition in Gaul", fr: "transition de l'Antiquité tardive en Gaule" }, note: { zh: "西罗马末期到法兰克王权形成前的过渡阶段。", en: "Transitional phase between late Roman rule and Frankish consolidation." } },
  { id: "frankish_fr", region: "europe", country: "FR", start: 481, end: 987, name: { zh: "法兰克王国", en: "Frankish Kingdom", fr: "royaume franc" }, note: { zh: "中世纪早期法兰西政体基础。", en: "Early medieval foundation of French state structures." } },
  { id: "capet_fr", region: "europe", country: "FR", start: 987, end: 1328, name: { zh: "卡佩王朝", en: "Capetian dynasty", fr: "dynastie capétienne" }, note: { zh: "法国王权逐步加强。", en: "Royal authority expanded gradually." } },
  { id: "valois_bourbon_fr", region: "europe", country: "FR", start: 1328, end: 1792, name: { zh: "瓦卢瓦/波旁王朝", en: "Valois/Bourbon monarchy", fr: "monarchie Valois/Bourbon" }, note: { zh: "君主制下的领土与制度整合。", en: "Territorial and institutional consolidation under monarchy." } },
  { id: "french_republic_1", region: "europe", country: "FR", start: 1792, end: 1804, name: { zh: "法兰西第一共和国", en: "First French Republic", fr: "Première République française" }, note: { zh: "革命时期政治制度剧变。", en: "Revolutionary transformation of political institutions." } },
  { id: "napoleon_fr", region: "europe", country: "FR", start: 1804, end: 1815, name: { zh: "法兰西第一帝国", en: "First French Empire", fr: "Premier Empire français" }, note: { zh: "拿破仑时代的欧陆重组。", en: "Continental reconfiguration during the Napoleonic era." } },
  { id: "restoration_fr", region: "europe", country: "FR", start: 1815, end: 1830, name: { zh: "波旁复辟", en: "Bourbon Restoration", fr: "Restauration bourbonienne" }, note: { zh: "君主制复辟与宪政尝试并行。", en: "Monarchical restoration and constitutional experiments overlapped." } },
  { id: "july_monarchy_fr", region: "europe", country: "FR", start: 1830, end: 1848, name: { zh: "七月王朝", en: "July Monarchy", fr: "Monarchie de Juillet" }, note: { zh: "资产阶级君主制阶段。", en: "A constitutional monarchy under bourgeois political dominance." } },
  { id: "french_republic_2", region: "europe", country: "FR", start: 1848, end: 1852, name: { zh: "法兰西第二共和国", en: "Second French Republic", fr: "Deuxième République française" }, note: { zh: "短暂共和体制与政局震荡。", en: "A short republican period with major political turbulence." } },
  { id: "french_empire_2", region: "europe", country: "FR", start: 1852, end: 1870, name: { zh: "法兰西第二帝国", en: "Second French Empire", fr: "Second Empire français" }, note: { zh: "拿破仑三世时期的国家重构。", en: "State restructuring under Napoleon III." } },
  { id: "french_republic_3", region: "europe", country: "FR", start: 1870, end: 1940, name: { zh: "法兰西第三共和国", en: "French Third Republic", fr: "Troisième République française" }, note: { zh: "长期共和体制，跨越两次大战前期。", en: "A long republican regime spanning the prewar and interwar eras." } },
  { id: "vichy_fr", region: "europe", country: "FR", start: 1940, end: 1944, name: { zh: "维希法国", en: "Vichy France", fr: "Régime de Vichy" }, note: { zh: "二战占领时期的政体。", en: "Regime during the occupation period in World War II." } },
  { id: "provisional_fr", region: "europe", country: "FR", start: 1944, end: 1946, name: { zh: "法兰西临时政府", en: "Provisional Government of France", fr: "Gouvernement provisoire de la République française" }, note: { zh: "战后重建与共和体制过渡。", en: "Postwar reconstruction and transition back to republican institutions." } },
  { id: "french_republic_4", region: "europe", country: "FR", start: 1946, end: 1958, name: { zh: "法兰西第四共和国", en: "French Fourth Republic", fr: "Quatrième République française" }, note: { zh: "战后议会共和阶段。", en: "Postwar parliamentary republican phase." } },
  { id: "french_republic_5", region: "europe", country: "FR", start: 1958, end: 2100, name: { zh: "法兰西第五共和国", en: "French Fifth Republic", fr: "Cinquième République française" }, note: { zh: "现代宪政体制持续。", en: "Modern constitutional framework continues." } },

  { id: "prehistoric_gb", region: "europe", country: "GB", start: -10000, end: -801, name: { zh: "不列颠史前文化阶段", en: "Prehistoric Britain", fr: "préhistoire de la Bretagne" }, note: { zh: "凯尔特部族成形前的史前与早期社会阶段。", en: "Prehistoric and early social phases before documented Celtic polities." } },
  { id: "celtic_gb", region: "europe", country: "GB", start: -800, end: 43, name: { zh: "不列颠凯尔特诸部", en: "Celtic Britain", fr: "Bretagne celtique" }, note: { zh: "罗马到来前的不列颠部族体系。", en: "Tribal polities in Britain before Roman annexation." } },
  { id: "roman_gb", region: "europe", country: "GB", start: 43, end: 410, name: { zh: "罗马不列颠", en: "Roman Britain", fr: "Bretagne romaine" }, note: { zh: "罗马帝国在不列颠的统治。", en: "Roman imperial administration in Britain." } },
  { id: "anglo_saxon_gb", region: "europe", country: "GB", start: 410, end: 1066, name: { zh: "盎格鲁-撒克逊诸国", en: "Anglo-Saxon kingdoms", fr: "royaumes anglo-saxons" }, note: { zh: "七国时代及统一进程。", en: "Heptarchy and later unification dynamics." } },
  { id: "england_medieval", region: "europe", country: "GB", start: 1066, end: 1485, name: { zh: "中世纪英格兰王国", en: "Medieval Kingdom of England", fr: "Royaume d'Angleterre médiéval" }, note: { zh: "封建王权与议会传统并进。", en: "Feudal monarchy and parliamentary roots evolved together." } },
  { id: "tudor_gb", region: "europe", country: "GB", start: 1486, end: 1602, name: { zh: "都铎王朝", en: "Tudor monarchy", fr: "monarchie Tudor" }, note: { zh: "中世纪后向近代国家结构过渡的重要阶段。", en: "A major transition from medieval to early modern state structures." } },
  { id: "stuart_gb", region: "europe", country: "GB", start: 1603, end: 1714, name: { zh: "斯图亚特王朝", en: "Stuart monarchy", fr: "monarchie Stuart" }, note: { zh: "王权与议会关系持续重塑。", en: "The crown-parliament balance was repeatedly renegotiated." } },
  { id: "uk_modern", region: "europe", country: "GB", start: 1707, end: 2100, name: { zh: "大不列颠及联合王国", en: "Kingdom/United Kingdom", fr: "Royaume-Uni" }, note: { zh: "联合王国与全球体系互动深。", en: "A union state deeply tied to global systems." } },

  { id: "prehistoric_de", region: "europe", country: "DE", start: -10000, end: -501, name: { zh: "德意志地区史前文化阶段", en: "Prehistoric Central Europe (German region)", fr: "préhistoire de l'espace germanique" }, note: { zh: "有文字史料前的史前文化演化阶段。", en: "Pre-literate cultural phases in the central European German region." } },
  { id: "germanic_de", region: "europe", country: "DE", start: -500, end: 800, name: { zh: "日耳曼诸部", en: "Germanic tribal polities", fr: "pouvoirs germaniques" }, note: { zh: "罗马边疆及后罗马时期诸部并立。", en: "Tribal and regional powers across Roman and post-Roman eras." } },
  { id: "carolingian_de", region: "europe", country: "DE", start: 801, end: 842, name: { zh: "加洛林过渡期", en: "Carolingian transition", fr: "transition carolingienne" }, note: { zh: "加洛林帝国后期至东法兰克建立前。", en: "Late Carolingian phase before the East Frankish polity emerged." } },
  { id: "east_francia_de", region: "europe", country: "DE", start: 843, end: 962, name: { zh: "东法兰克王国", en: "East Francia", fr: "Francie orientale" }, note: { zh: "德意志中世纪王权前身。", en: "A core predecessor to medieval German kingship." } },
  { id: "holy_roman", region: "europe", country: "DE", start: 962, end: 1806, name: { zh: "神圣罗马帝国", en: "Holy Roman Empire", fr: "Saint-Empire romain germanique" }, note: { zh: "多中心政治结构长期延续。", en: "A long-lived multi-centered imperial order." } },
  { id: "german_confed_de", region: "europe", country: "DE", start: 1807, end: 1870, name: { zh: "德意志邦联过渡期", en: "German confederal transition", fr: "transition confédérale allemande" }, note: { zh: "神圣罗马帝国解体后至统一帝国建立前。", en: "Confederal and transitional state structures before imperial unification." } },
  { id: "german_empire", region: "europe", country: "DE", start: 1871, end: 1918, name: { zh: "德意志帝国", en: "German Empire", fr: "Empire allemand" }, note: { zh: "统一后的工业化强国。", en: "A unified and rapidly industrialized power." } },
  { id: "weimar_de", region: "europe", country: "DE", start: 1919, end: 1933, name: { zh: "魏玛共和国", en: "Weimar Republic", fr: "République de Weimar" }, note: { zh: "战间期民主实验。", en: "An interwar democratic experiment." } },
  { id: "nazi_de", region: "europe", country: "DE", start: 1934, end: 1945, name: { zh: "纳粹德国", en: "Nazi Germany", fr: "Allemagne nazie" }, note: { zh: "极权统治与战争时期。", en: "Totalitarian regime during the Second World War period." } },
  { id: "occupation_de", region: "europe", country: "DE", start: 1946, end: 1948, name: { zh: "战后占领与重建", en: "Postwar occupation and reconstruction", fr: "occupation et reconstruction d'après-guerre" }, note: { zh: "联邦德国成立前的占领与制度重建阶段。", en: "Occupation and institutional reconstruction before the Federal Republic." } },
  { id: "federal_de", region: "europe", country: "DE", start: 1949, end: 2100, name: { zh: "德意志联邦共和国", en: "Federal Republic of Germany", fr: "République fédérale d'Allemagne" }, note: { zh: "战后联邦民主制度巩固。", en: "Postwar federal democratic institutions consolidated." } },

  { id: "prehistoric_ru", region: "europe", country: "RU", start: -10000, end: -801, name: { zh: "东欧草原与森林带史前阶段", en: "Prehistoric East European plain", fr: "préhistoire de la plaine est-européenne" }, note: { zh: "斯拉夫国家形成前的长期史前文化阶段。", en: "Long prehistoric phases before the emergence of East Slavic polities." } },
  { id: "east_slavs_ru", region: "europe", country: "RU", start: -800, end: 882, name: { zh: "东斯拉夫早期共同体", en: "Early East Slavic polities", fr: "pouvoirs slaves orientaux" }, note: { zh: "罗斯国家形成前的区域共同体。", en: "Regional communities before the rise of Rus' state structures." } },
  { id: "kievan_rus", region: "europe", country: "RU", start: 882, end: 1240, name: { zh: "基辅罗斯", en: "Kievan Rus'", fr: "Rus' de Kiev" }, note: { zh: "东欧早期国家网络。", en: "An early East European state network." } },
  { id: "rus_fragmentation_ru", region: "europe", country: "RU", start: 1241, end: 1282, name: { zh: "罗斯诸公国与蒙古宗主期", en: "Rus principalities under Mongol suzerainty", fr: "principautés russes sous suzeraineté mongole" }, note: { zh: "基辅罗斯之后、莫斯科崛起之前的过渡阶段。", en: "Transition between Kievan Rus and Muscovite consolidation." } },
  { id: "muscovy_ru", region: "europe", country: "RU", start: 1283, end: 1547, name: { zh: "莫斯科大公国", en: "Grand Duchy of Moscow", fr: "Grande-principauté de Moscou" }, note: { zh: "罗斯后期整合与扩张阶段。", en: "Post-Rus consolidation that set up later Tsardom expansion." } },
  { id: "tsardom_ru", region: "europe", country: "RU", start: 1547, end: 1721, name: { zh: "俄罗斯沙皇国", en: "Tsardom of Russia", fr: "tsarat de Russie" }, note: { zh: "扩张中的近代早期王权。", en: "An expanding early modern monarchy." } },
  { id: "empire_ru", region: "europe", country: "RU", start: 1721, end: 1917, name: { zh: "俄罗斯帝国", en: "Russian Empire", fr: "Empire russe" }, note: { zh: "横跨欧亚的大帝国。", en: "A major empire spanning Europe and Asia." } },
  { id: "civil_war_ru", region: "europe", country: "RU", start: 1918, end: 1921, name: { zh: "俄国内战与苏维埃过渡期", en: "Russian Civil War transition", fr: "transition de la guerre civile russe" }, note: { zh: "帝国瓦解后到苏联成立前的过渡阶段。", en: "Transition between imperial collapse and formal Soviet Union establishment." } },
  { id: "ussr_ru", region: "europe", country: "RU", start: 1922, end: 1991, name: { zh: "苏联", en: "Soviet Union", fr: "Union soviétique" }, note: { zh: "20世纪关键超级大国之一。", en: "One of the key global superpowers of the 20th century." } },
  { id: "rf_ru", region: "europe", country: "RU", start: 1991, end: 2100, name: { zh: "俄罗斯联邦", en: "Russian Federation", fr: "Fédération de Russie" }, note: { zh: "后冷战国家体制转型。", en: "State structures transformed in the post-Cold War era." } },

  { id: "prehistoric_eg", region: "africa", country: "EG", start: -10000, end: -3001, name: { zh: "埃及史前文化阶段", en: "Prehistoric Egypt", fr: "préhistoire de l'Égypte" }, note: { zh: "王朝国家形成前的尼罗河流域史前阶段。", en: "Pre-dynastic and prehistoric phases before pharaonic state formation." } },
  { id: "early_dynastic_eg", region: "africa", country: "EG", start: -3000, end: -2686, name: { zh: "埃及早王朝时期", en: "Early Dynastic Egypt", fr: "Égypte dynastique ancienne" }, note: { zh: "尼罗河国家形成阶段。", en: "State consolidation phase along the Nile." } },
  { id: "old_kingdom_eg", region: "africa", country: "EG", start: -2686, end: -2181, name: { zh: "埃及古王国", en: "Old Kingdom Egypt", fr: "Ancien Empire d'Égypte" }, note: { zh: "金字塔时代与中央王权强化。", en: "Pyramid age with strong central kingship." } },
  { id: "first_intermediate_eg", region: "africa", country: "EG", start: -2180, end: -2056, name: { zh: "第一中间期", en: "First Intermediate Period", fr: "Première Période intermédiaire" }, note: { zh: "古王国与中王国之间的政权分化阶段。", en: "Fragmentation phase between the Old and Middle Kingdoms." } },
  { id: "middle_kingdom_eg", region: "africa", country: "EG", start: -2055, end: -1650, name: { zh: "埃及中王国", en: "Middle Kingdom Egypt", fr: "Moyen Empire d'Égypte" }, note: { zh: "国家再统一与行政整合。", en: "Reunification and administrative reorganization." } },
  { id: "second_intermediate_eg", region: "africa", country: "EG", start: -1649, end: -1551, name: { zh: "第二中间期", en: "Second Intermediate Period", fr: "Deuxième Période intermédiaire" }, note: { zh: "中王国与新王国之间的过渡期。", en: "Transitional period between Middle and New Kingdom phases." } },
  { id: "new_kingdom_eg", region: "africa", country: "EG", start: -1550, end: -1069, name: { zh: "埃及新王国", en: "New Kingdom Egypt", fr: "Nouvel Empire d'Égypte" }, note: { zh: "古埃及对外扩张高峰。", en: "Peak phase of pharaonic external expansion." } },
  { id: "ancient_egypt", region: "africa", country: "EG", start: -1069, end: -30, name: { zh: "后期古埃及", en: "Late Ancient Egypt", fr: "Égypte antique tardive" }, note: { zh: "尼罗河文明晚期阶段。", en: "Late phase of Nile-based civilization." } },
  { id: "roman_byzantine_eg", region: "africa", country: "EG", start: -29, end: 641, name: { zh: "罗马-拜占庭埃及", en: "Roman-Byzantine Egypt", fr: "Égypte romano-byzantine" }, note: { zh: "托勒密后到阿拉伯征服前的地中海统治阶段。", en: "Mediterranean imperial phase from Roman rule to Arab conquest." } },
  { id: "islamic_eg", region: "africa", country: "EG", start: 642, end: 1249, name: { zh: "伊斯兰王朝时期", en: "Islamic dynasties in Egypt", fr: "dynasties islamiques d'Égypte" }, note: { zh: "法蒂玛等王朝时期，至马穆鲁克之前。", en: "Islamic dynastic phases prior to Mamluk rule." } },
  { id: "mamluk_eg", region: "africa", country: "EG", start: 1250, end: 1517, name: { zh: "马穆鲁克苏丹国", en: "Mamluk Sultanate", fr: "sultanat mamelouk" }, note: { zh: "东地中海与红海通道枢纽。", en: "A key hub for East Mediterranean and Red Sea trade." } },
  { id: "ottoman_eg", region: "africa", country: "EG", start: 1517, end: 1867, name: { zh: "奥斯曼埃及", en: "Ottoman Egypt", fr: "Égypte ottomane" }, note: { zh: "帝国内部的关键行省。", en: "A strategically important province within a larger empire." } },
  { id: "khedivate_eg", region: "africa", country: "EG", start: 1868, end: 1921, name: { zh: "赫迪夫与苏丹时期", en: "Khedivate and Sultanate of Egypt", fr: "khédivat et sultanat d'Égypte" }, note: { zh: "奥斯曼晚期与英方影响下的过渡治理。", en: "Transitional governance under late Ottoman and British influence." } },
  { id: "kingdom_eg", region: "africa", country: "EG", start: 1922, end: 1952, name: { zh: "埃及王国", en: "Kingdom of Egypt", fr: "Royaume d'Égypte" }, note: { zh: "现代共和国建立前的君主立宪阶段。", en: "Monarchical phase before the modern republic." } },
  { id: "egypt_modern", region: "africa", country: "EG", start: 1953, end: 2100, name: { zh: "阿拉伯埃及共和国", en: "Arab Republic of Egypt", fr: "République arabe d'Égypte" }, note: { zh: "现代民族国家阶段。", en: "Modern republican nation-state phase." } },

  { id: "prehistoric_et", region: "africa", country: "ET", start: -10000, end: -981, name: { zh: "埃塞高地史前文化阶段", en: "Ethiopian highlands prehistory", fr: "préhistoire des hauts plateaux éthiopiens" }, note: { zh: "达摩特形成前的早期人群与聚落阶段。", en: "Early settlement phases before the D'mt polity." } },
  { id: "dmt_et", region: "africa", country: "ET", start: -980, end: -400, name: { zh: "达摩特王国", en: "D'mt Kingdom", fr: "royaume de D'mt" }, note: { zh: "埃塞高地早期国家实体。", en: "An early state formation in the Ethiopian highlands." } },
  { id: "pre_aksum_et", region: "africa", country: "ET", start: -399, end: 99, name: { zh: "前阿克苏姆过渡期", en: "Pre-Aksum transition", fr: "transition pré-Aksoum" }, note: { zh: "达摩特后到阿克苏姆兴起前的过渡阶段。", en: "Transition between D'mt and the rise of Aksum." } },
  { id: "aksum_et", region: "africa", country: "ET", start: 100, end: 940, name: { zh: "阿克苏姆", en: "Kingdom of Aksum", fr: "royaume d'Aksoum" }, note: { zh: "红海贸易网络中的重要王国。", en: "A key kingdom in Red Sea trade networks." } },
  { id: "zagwe_et", region: "africa", country: "ET", start: 941, end: 1269, name: { zh: "扎格维王朝", en: "Zagwe dynasty", fr: "dynastie Zagwe" }, note: { zh: "阿克苏姆后至所罗门王朝复兴前的王朝阶段。", en: "Dynastic phase between Aksum and Solomonic restoration." } },
  { id: "solomonic_et", region: "africa", country: "ET", start: 1270, end: 1974, name: { zh: "所罗门王朝", en: "Solomonic dynasty", fr: "dynastie salomonide" }, note: { zh: "长期延续的高地王朝体系。", en: "A long-running highland dynastic polity." } },
  { id: "derg_et", region: "africa", country: "ET", start: 1975, end: 1994, name: { zh: "德尔格时期", en: "Derg period", fr: "période du Derg" }, note: { zh: "王朝终结后到联邦体制前的政权阶段。", en: "Regime phase between imperial collapse and federal restructuring." } },
  { id: "ethiopia_federal", region: "africa", country: "ET", start: 1995, end: 2100, name: { zh: "埃塞俄比亚联邦", en: "Federal Ethiopia", fr: "Éthiopie fédérale" }, note: { zh: "联邦框架下的现代治理。", en: "Modern governance under a federal framework." } },

  { id: "prehistoric_ml", region: "africa", country: "ML", start: -10000, end: 299, name: { zh: "西非史前与早期聚落阶段", en: "West African prehistory (Mali region)", fr: "préhistoire ouest-africaine (région du Mali)" }, note: { zh: "加纳帝国之前的史前与早期社会发展阶段。", en: "Prehistoric and early social phases before the Ghana Empire." } },
  { id: "ghana_ml", region: "africa", country: "ML", start: 300, end: 1240, name: { zh: "加纳帝国", en: "Ghana Empire", fr: "Empire du Ghana" }, note: { zh: "西非早期跨撒哈拉贸易强权。", en: "An early trans-Saharan trading power in West Africa." } },
  { id: "mali_empire", region: "africa", country: "ML", start: 1235, end: 1670, name: { zh: "马里帝国", en: "Mali Empire", fr: "Empire du Mali" }, note: { zh: "西非跨撒哈拉贸易重镇。", en: "A major power in trans-Saharan commerce." } },
  { id: "songhai_ml", region: "africa", country: "ML", start: 1464, end: 1591, name: { zh: "桑海帝国", en: "Songhai Empire", fr: "Empire songhaï" }, note: { zh: "继马里后的区域强权。", en: "Regional imperial successor to Mali." } },
  { id: "post_imperial_ml", region: "africa", country: "ML", start: 1671, end: 1959, name: { zh: "后帝国与殖民过渡期", en: "Post-imperial and colonial transition", fr: "transition post-impériale et coloniale" }, note: { zh: "桑海之后到共和国建立前的长期过渡阶段。", en: "Long transition after Songhai and before republican statehood." } },
  { id: "mali_republic", region: "africa", country: "ML", start: 1960, end: 2100, name: { zh: "马里共和国", en: "Republic of Mali", fr: "République du Mali" }, note: { zh: "后殖民国家阶段。", en: "Post-colonial nation-state period." } },

  { id: "prehistoric_mx", region: "americas", country: "MX", start: -10000, end: -1201, name: { zh: "中美洲史前文化阶段", en: "Mesoamerican prehistory (Mexico)", fr: "préhistoire mésoaméricaine (Mexique)" }, note: { zh: "奥尔梅克之前的早期定居与文化发展阶段。", en: "Early settlement and cultural development before Olmec complexity." } },
  { id: "olmec_mx", region: "americas", country: "MX", start: -1200, end: -400, name: { zh: "奥尔梅克文明", en: "Olmec civilization", fr: "civilisation olmèque" }, note: { zh: "中美洲早期城市文明与宗教传统。", en: "Early Mesoamerican urban and ritual traditions." } },
  { id: "formative_mx", region: "americas", country: "MX", start: -399, end: 249, name: { zh: "中美洲前古典晚期", en: "Late Formative Mesoamerica", fr: "Mésoamérique formative tardive" }, note: { zh: "奥尔梅克之后到玛雅古典前的长期过渡。", en: "Long transition between Olmec decline and the Classic Maya era." } },
  { id: "maya_mx", region: "americas", country: "MX", start: 250, end: 900, name: { zh: "玛雅古典时期", en: "Classic Maya polities", fr: "pouvoirs mayas classiques" }, note: { zh: "玛雅城邦网络繁荣阶段。", en: "Flourishing network of Maya city-states." } },
  { id: "postclassic_mx", region: "americas", country: "MX", start: 901, end: 1427, name: { zh: "中美洲后古典早期", en: "Early Postclassic Mesoamerica", fr: "début du Postclassique mésoaméricain" }, note: { zh: "玛雅古典后到阿兹特克联盟形成前的区域政权阶段。", en: "Regional postclassic polities before Aztec imperial consolidation." } },
  { id: "aztec_mx", region: "americas", country: "MX", start: 1428, end: 1521, name: { zh: "阿兹特克联盟", en: "Aztec Triple Alliance", fr: "Triple alliance aztèque" }, note: { zh: "中美洲后古典时期强权。", en: "A major Mesoamerican polity in the late pre-contact era." } },
  { id: "conquest_transition_mx", region: "americas", country: "MX", start: 1522, end: 1534, name: { zh: "征服后过渡期", en: "Post-conquest transition", fr: "transition post-conquête" }, note: { zh: "阿兹特克崩解至新西班牙建制前的过渡。", en: "Transition between Aztec collapse and formal New Spain administration." } },
  { id: "new_spain_mx", region: "americas", country: "MX", start: 1535, end: 1821, name: { zh: "新西班牙总督区", en: "Viceroyalty of New Spain", fr: "vice-royauté de Nouvelle-Espagne" }, note: { zh: "殖民帝国在美洲的重要中心。", en: "A core administrative center of colonial empire in the Americas." } },
  { id: "first_empire_mx", region: "americas", country: "MX", start: 1822, end: 1823, name: { zh: "墨西哥第一帝国", en: "First Mexican Empire", fr: "Premier Empire mexicain" }, note: { zh: "独立后共和国前的短暂帝制阶段。", en: "Short imperial phase between independence and republican reorganization." } },
  { id: "mexico_republic", region: "americas", country: "MX", start: 1824, end: 2100, name: { zh: "墨西哥共和国", en: "Mexican Republic", fr: "République mexicaine" }, note: { zh: "独立后现代国家建设阶段。", en: "Modern nation-state development after independence." } },

  { id: "prehistoric_pe", region: "americas", country: "PE", start: -10000, end: -3001, name: { zh: "安第斯史前文化阶段", en: "Andean prehistory (Peru)", fr: "préhistoire andine (Pérou)" }, note: { zh: "卡拉尔文明前的早期安第斯定居阶段。", en: "Early Andean settlement phases before Norte Chico urbanization." } },
  { id: "norte_chico_pe", region: "americas", country: "PE", start: -3000, end: -1800, name: { zh: "卡拉尔文明", en: "Norte Chico civilization", fr: "civilisation de Norte Chico" }, note: { zh: "安第斯地区早期城市文明。", en: "One of the earliest urban civilizations in the Andes." } },
  { id: "early_andean_pe", region: "americas", country: "PE", start: -1799, end: -901, name: { zh: "安第斯早期文化整合期", en: "Early Andean cultural integration", fr: "intégration culturelle andine ancienne" }, note: { zh: "卡拉尔之后到查文形成前的区域发展阶段。", en: "Regional development between Norte Chico decline and Chavin florescence." } },
  { id: "chavin_pe", region: "americas", country: "PE", start: -900, end: -200, name: { zh: "查文文化", en: "Chavin horizon", fr: "horizon Chavin" }, note: { zh: "安第斯早期宗教与文化整合中心。", en: "An early Andean ritual and cultural integration center." } },
  { id: "early_intermediate_pe", region: "americas", country: "PE", start: -199, end: 99, name: { zh: "安第斯早期中间期", en: "Early Intermediate Andes", fr: "Andes: début de la période intermédiaire" }, note: { zh: "查文之后到莫切扩张前的过渡阶段。", en: "Transition between Chavin decline and Moche regional expansion." } },
  { id: "moche_pe", region: "americas", country: "PE", start: 100, end: 700, name: { zh: "莫切文化", en: "Moche polities", fr: "pouvoirs mochica" }, note: { zh: "沿海复杂社会和政治体发展。", en: "Complex coastal societies with advanced political organization." } },
  { id: "regional_andean_pe", region: "americas", country: "PE", start: 701, end: 1437, name: { zh: "安第斯区域政权时期", en: "Regional Andean states", fr: "États andins régionaux" }, note: { zh: "莫切之后到印加崛起前的多政权并存阶段。", en: "Multi-polity Andean phase before Inca imperial consolidation." } },
  { id: "inca_pe", region: "americas", country: "PE", start: 1438, end: 1533, name: { zh: "印加帝国", en: "Inca Empire", fr: "Empire inca" }, note: { zh: "安第斯地区大型帝国。", en: "A large Andean imperial system." } },
  { id: "conquest_transition_pe", region: "americas", country: "PE", start: 1534, end: 1541, name: { zh: "征服后过渡期", en: "Post-conquest transition", fr: "transition post-conquête" }, note: { zh: "印加解体至总督区建制前的过渡。", en: "Transition between Inca collapse and formal viceroyal administration." } },
  { id: "peru_viceroyalty", region: "americas", country: "PE", start: 1542, end: 1824, name: { zh: "秘鲁总督区", en: "Viceroyalty of Peru", fr: "vice-royauté du Pérou" }, note: { zh: "西属南美的主要统治单元。", en: "A principal colonial unit in Spanish South America." } },
  { id: "peru_republic", region: "americas", country: "PE", start: 1824, end: 2100, name: { zh: "秘鲁共和国", en: "Republic of Peru", fr: "République du Pérou" }, note: { zh: "独立后共和国体制延续。", en: "Republican institutions continued after independence." } },

  { id: "indigenous_us", region: "americas", country: "US", start: -10000, end: 1607, name: { zh: "北美原住民诸文明", en: "Indigenous North American polities", fr: "pouvoirs autochtones d'Amérique du Nord" }, note: { zh: "多样化原住民政治与文化体系。", en: "Diverse indigenous political and cultural systems." } },
  { id: "colonies_us", region: "americas", country: "US", start: 1607, end: 1776, name: { zh: "北美英属殖民地", en: "British North American Colonies", fr: "Colonies britanniques d'Amérique du Nord" }, note: { zh: "大西洋殖民体系的重要组成。", en: "A core part of the Atlantic colonial system." } },
  { id: "usa", region: "americas", country: "US", start: 1776, end: 2100, name: { zh: "美利坚合众国", en: "United States", fr: "États-Unis" }, note: { zh: "近现代全球体系中的关键国家。", en: "A central state in the modern global order." } },

  { id: "aboriginal_au", region: "oceania", country: "AU", start: -10000, end: 1788, name: { zh: "澳洲原住民社群", en: "Aboriginal societies", fr: "sociétés aborigènes" }, note: { zh: "多样化的原住民社会网络。", en: "Diverse indigenous societies across the continent." } },
  { id: "colonial_au", region: "oceania", country: "AU", start: 1788, end: 1901, name: { zh: "澳洲殖民地", en: "Australian colonies", fr: "colonies australiennes" }, note: { zh: "英帝国殖民扩展阶段。", en: "Colonial expansion under the British imperial framework." } },
  { id: "commonwealth_au", region: "oceania", country: "AU", start: 1901, end: 2100, name: { zh: "澳大利亚联邦", en: "Commonwealth of Australia", fr: "Commonwealth d'Australie" }, note: { zh: "联邦国家体制延续。", en: "Federal national institutions continue." } },

  { id: "pre_settlement_nz", region: "oceania", country: "NZ", start: -10000, end: 899, name: { zh: "新西兰无人定居阶段", en: "Pre-settlement Aotearoa", fr: "Aotearoa avant peuplement" }, note: { zh: "波利尼西亚人到来前，尚无人类定居记录。", en: "No confirmed human settlement before Polynesian arrival." } },
  { id: "polynesian_nz", region: "oceania", country: "NZ", start: 900, end: 1200, name: { zh: "波利尼西亚定居阶段", en: "Early Polynesian settlement", fr: "première installation polynésienne" }, note: { zh: "新西兰地区早期海洋移民阶段。", en: "Early seafaring settlement phase in Aotearoa." } },
  { id: "maori_nz", region: "oceania", country: "NZ", start: 1200, end: 1840, name: { zh: "毛利部族联盟", en: "Maori iwi polities", fr: "entités maories" }, note: { zh: "多中心部族政治结构。", en: "Multi-centered indigenous political structures." } },
  { id: "colonial_nz", region: "oceania", country: "NZ", start: 1841, end: 1907, name: { zh: "新西兰殖民地", en: "Colony of New Zealand", fr: "colonie de Nouvelle-Zélande" }, note: { zh: "殖民治理阶段。", en: "Colonial governance phase." } },
  { id: "nz_modern", region: "oceania", country: "NZ", start: 1907, end: 2100, name: { zh: "现代新西兰", en: "Modern New Zealand", fr: "Nouvelle-Zélande moderne" }, note: { zh: "自治与议会制度持续发展。", en: "Self-government and parliamentary institutions evolved." } }
];

const SOURCE_CATALOG = {
  britannica_china_history: { label: "Encyclopaedia Britannica - China: History", url: "https://www.britannica.com/place/China/History" },
  britannica_china_paleolithic: { label: "Encyclopaedia Britannica - China: Paleolithic", url: "https://www.britannica.com/place/China/The-Paleolithic-Period" },
  britannica_china_neolithic: { label: "Encyclopaedia Britannica - China: Neolithic", url: "https://www.britannica.com/place/China/The-Neolithic-Period" },
  britannica_xia: { label: "Encyclopaedia Britannica - Xia dynasty", url: "https://www.britannica.com/topic/Xia-dynasty" },
  britannica_qin: { label: "Encyclopaedia Britannica - Qin dynasty", url: "https://www.britannica.com/topic/Qin-dynasty" },
  britannica_huangdi: { label: "Encyclopaedia Britannica - Huangdi", url: "https://www.britannica.com/topic/Huangdi" },
  britannica_japan_history: { label: "Encyclopaedia Britannica - Japan: History", url: "https://www.britannica.com/place/Japan/History" },
  britannica_jomon: { label: "Encyclopaedia Britannica - Jomon culture", url: "https://www.britannica.com/topic/Jomon-culture" },
  britannica_korea: { label: "Encyclopaedia Britannica - Korea", url: "https://www.britannica.com/place/Korea" },
  britannica_india_history: { label: "Encyclopaedia Britannica - India: History", url: "https://www.britannica.com/place/India/History" },
  britannica_iran_history: { label: "Encyclopaedia Britannica - Ancient Iran", url: "https://www.britannica.com/place/ancient-Iran/Persian-dynasties" },
  britannica_turkey_history: { label: "Encyclopaedia Britannica - Turkey: History", url: "https://www.britannica.com/place/Turkey/History" },
  britannica_russia_history: { label: "Encyclopaedia Britannica - Russia: History", url: "https://www.britannica.com/place/Russia/History" },
  britannica_germany_history: { label: "Encyclopaedia Britannica - Germany: History", url: "https://www.britannica.com/place/Germany/History" },
  britannica_france_history: { label: "Encyclopaedia Britannica - History of France", url: "https://www.britannica.com/topic/history-of-France" },
  britannica_uk_history: { label: "Encyclopaedia Britannica - United Kingdom: History", url: "https://www.britannica.com/place/United-Kingdom/History" },
  britannica_italy_history: { label: "Encyclopaedia Britannica - Italy: History", url: "https://www.britannica.com/place/Italy/History" },
  britannica_egypt_history: { label: "Encyclopaedia Britannica - Ancient Egypt: History", url: "https://www.britannica.com/place/ancient-Egypt/History" },
  britannica_ethiopia_history: { label: "Encyclopaedia Britannica - Ethiopia: History", url: "https://www.britannica.com/place/Ethiopia/History" },
  britannica_mali: { label: "Encyclopaedia Britannica - Mali", url: "https://www.britannica.com/place/Mali" },
  britannica_mexico_history: { label: "Encyclopaedia Britannica - Mexico: History", url: "https://www.britannica.com/place/Mexico/History" },
  britannica_peru_history: { label: "Encyclopaedia Britannica - Peru: History", url: "https://www.britannica.com/place/Peru/History" },
  britannica_us_history: { label: "Encyclopaedia Britannica - United States: History", url: "https://www.britannica.com/place/United-States/History" },
  britannica_australia_aboriginal: { label: "Encyclopaedia Britannica - Australian Aboriginal peoples", url: "https://www.britannica.com/topic/Australian-Aboriginal" },
  britannica_maori: { label: "Encyclopaedia Britannica - Maori", url: "https://www.britannica.com/topic/Maori" }
};

const COUNTRY_SOURCE_MAP = {
  CN: ["britannica_china_history", "britannica_china_paleolithic", "britannica_china_neolithic"],
  JP: ["britannica_japan_history", "britannica_jomon"],
  KR: ["britannica_korea"],
  IN: ["britannica_india_history"],
  IR: ["britannica_iran_history"],
  TR: ["britannica_turkey_history"],
  RU: ["britannica_russia_history"],
  FR: ["britannica_france_history"],
  GB: ["britannica_uk_history"],
  DE: ["britannica_germany_history"],
  IT: ["britannica_italy_history"],
  EG: ["britannica_egypt_history"],
  ET: ["britannica_ethiopia_history"],
  ML: ["britannica_mali"],
  MX: ["britannica_mexico_history"],
  PE: ["britannica_peru_history"],
  US: ["britannica_us_history"],
  AU: ["britannica_australia_aboriginal"],
  NZ: ["britannica_maori"]
};

const POLITY_META = {
  paleolithic_cn: { confidence: "medium", sources: ["britannica_china_paleolithic", "britannica_china_history"] },
  neolithic_cn: { confidence: "high", sources: ["britannica_china_neolithic", "britannica_china_history"] },
  yanhuang_cn: { confidence: "legendary", sources: ["britannica_huangdi", "britannica_china_history"] },
  xia_cn: { confidence: "traditional", sources: ["britannica_xia", "britannica_china_history"] },
  qin_cn: { confidence: "high", sources: ["britannica_qin", "britannica_china_history"] },
  late_zhou_cn: { confidence: "medium", sources: ["britannica_china_history"] },
  chu_han_cn: { confidence: "medium", sources: ["britannica_china_history"] },
  jomon_jp: { confidence: "high", sources: ["britannica_jomon", "britannica_japan_history"] },
  kenmu_jp: { confidence: "medium", sources: ["britannica_japan_history"] },
  sengoku_jp: { confidence: "medium", sources: ["britannica_japan_history"] },
  prehistoric_kr: { confidence: "medium", sources: ["britannica_korea"] },
  gojoseon_kr: { confidence: "traditional", sources: ["britannica_korea"] },
  proto_three_kingdoms_kr: { confidence: "medium", sources: ["britannica_korea"] },
  modern_transition_kr: { confidence: "medium", sources: ["britannica_korea"] },
  prehistoric_in: { confidence: "medium", sources: ["britannica_india_history"] },
  late_harappan_in: { confidence: "medium", sources: ["britannica_india_history"] },
  dominion_in: { confidence: "medium", sources: ["britannica_india_history"] },
  prehistoric_ir: { confidence: "medium", sources: ["britannica_iran_history"] },
  seleucid_ir: { confidence: "medium", sources: ["britannica_iran_history"] },
  islamic_dynasties_ir: { confidence: "medium", sources: ["britannica_iran_history"] },
  afshar_zand_ir: { confidence: "medium", sources: ["britannica_iran_history"] },
  prehistoric_tr: { confidence: "medium", sources: ["britannica_turkey_history"] },
  hellenistic_tr: { confidence: "medium", sources: ["britannica_turkey_history"] },
  prehistoric_fr: { confidence: "medium", sources: ["britannica_france_history"] },
  late_antiquity_fr: { confidence: "medium", sources: ["britannica_france_history"] },
  prehistoric_gb: { confidence: "medium", sources: ["britannica_uk_history"] },
  tudor_gb: { confidence: "high", sources: ["britannica_uk_history"] },
  prehistoric_de: { confidence: "medium", sources: ["britannica_germany_history"] },
  carolingian_de: { confidence: "medium", sources: ["britannica_germany_history"] },
  german_confed_de: { confidence: "medium", sources: ["britannica_germany_history"] },
  nazi_de: { confidence: "high", sources: ["britannica_germany_history"] },
  occupation_de: { confidence: "medium", sources: ["britannica_germany_history"] },
  prehistoric_it: { confidence: "medium", sources: ["britannica_italy_history"] },
  post_roman_it: { confidence: "medium", sources: ["britannica_italy_history"] },
  prehistoric_ru: { confidence: "medium", sources: ["britannica_russia_history"] },
  rus_fragmentation_ru: { confidence: "medium", sources: ["britannica_russia_history"] },
  civil_war_ru: { confidence: "high", sources: ["britannica_russia_history"] },
  prehistoric_eg: { confidence: "medium", sources: ["britannica_egypt_history"] },
  first_intermediate_eg: { confidence: "medium", sources: ["britannica_egypt_history"] },
  second_intermediate_eg: { confidence: "medium", sources: ["britannica_egypt_history"] },
  roman_byzantine_eg: { confidence: "medium", sources: ["britannica_egypt_history"] },
  islamic_eg: { confidence: "medium", sources: ["britannica_egypt_history"] },
  khedivate_eg: { confidence: "medium", sources: ["britannica_egypt_history"] },
  kingdom_eg: { confidence: "high", sources: ["britannica_egypt_history"] },
  prehistoric_et: { confidence: "medium", sources: ["britannica_ethiopia_history"] },
  pre_aksum_et: { confidence: "medium", sources: ["britannica_ethiopia_history"] },
  zagwe_et: { confidence: "high", sources: ["britannica_ethiopia_history"] },
  derg_et: { confidence: "high", sources: ["britannica_ethiopia_history"] },
  prehistoric_ml: { confidence: "medium", sources: ["britannica_mali"] },
  post_imperial_ml: { confidence: "medium", sources: ["britannica_mali"] },
  prehistoric_mx: { confidence: "medium", sources: ["britannica_mexico_history"] },
  formative_mx: { confidence: "medium", sources: ["britannica_mexico_history"] },
  postclassic_mx: { confidence: "medium", sources: ["britannica_mexico_history"] },
  conquest_transition_mx: { confidence: "medium", sources: ["britannica_mexico_history"] },
  first_empire_mx: { confidence: "high", sources: ["britannica_mexico_history"] },
  prehistoric_pe: { confidence: "medium", sources: ["britannica_peru_history"] },
  early_andean_pe: { confidence: "medium", sources: ["britannica_peru_history"] },
  early_intermediate_pe: { confidence: "medium", sources: ["britannica_peru_history"] },
  regional_andean_pe: { confidence: "medium", sources: ["britannica_peru_history"] },
  conquest_transition_pe: { confidence: "medium", sources: ["britannica_peru_history"] },
  indigenous_us: { confidence: "medium", sources: ["britannica_us_history"] },
  aboriginal_au: { confidence: "high", sources: ["britannica_australia_aboriginal"] },
  pre_settlement_nz: { confidence: "medium", sources: ["britannica_maori"] },
  polynesian_nz: { confidence: "medium", sources: ["britannica_maori"] }
};

const CONFIDENCE_WEIGHT = {
  high: 4,
  medium: 3,
  traditional: 2,
  legendary: 1
};

const COUNTRY_FLAGS = {
  CN: "🇨🇳",
  JP: "🇯🇵",
  KR: "🇰🇷",
  IN: "🇮🇳",
  IR: "🇮🇷",
  TR: "🇹🇷",
  RU: "🇷🇺",
  FR: "🇫🇷",
  GB: "🇬🇧",
  DE: "🇩🇪",
  IT: "🇮🇹",
  EG: "🇪🇬",
  ET: "🇪🇹",
  ML: "🇲🇱",
  MX: "🇲🇽",
  PE: "🇵🇪",
  US: "🇺🇸",
  AU: "🇦🇺",
  NZ: "🇳🇿"
};

// Country-centric base hues, then each polity shifts around this axis.
const COUNTRY_CULTURE_HUE = {
  CN: 6,
  JP: 350,
  KR: 332,
  IN: 33,
  IR: 266,
  TR: 2,
  RU: 221,
  FR: 226,
  GB: 214,
  DE: 48,
  IT: 136,
  EG: 29,
  ET: 82,
  ML: 140,
  MX: 162,
  PE: 348,
  US: 216,
  AU: 268,
  NZ: 186
};

const DYNASTY_COLOR_CACHE = buildDynastyColorCache();
const DYNASTY_ORDER_CACHE = buildDynastyOrderCache();

const EXTRA_UI = {
  zh: {
    "panel.title": "参数面板",
    "panel.hint": "左侧控制参数，右侧保持连续浏览。可切换国家列、粒度和年份焦点。",
    "panel.yearFocus": "年份焦点",
    "panel.columns": "国家列",
    "panel.selectAll": "全选",
    "panel.density": "时间粒度",
    "panel.collapse": "收起面板",
    "panel.expand": "展开面板",
    "panel.prev": "上一段",
    "panel.next": "下一段",
    "panel.density.fine": "高密度（40年）",
    "panel.density.medium": "平衡（60年）",
    "panel.density.coarse": "概览（100年）",
    "chart.kicker": "全球并列历史图谱",
    "chart.title": "纵向瀑布流时间图",
    "chart.desc": "每一列是一个国家，每一行是一段时间。悬停可高亮整列与整行，点击色块查看同期世界信息。",
    "chart.columnHint": "提示：点击上方国家名称可隐藏/恢复该列（至少保留 1 列）。",
    "chart.mobileHint": "手机端可左右滑动图表，也可用上方国家切换器快速定位。",
    "chart.mobilePrev": "上一个国家",
    "chart.mobileNext": "下一个国家",
    "chart.toastHidden": "已隐藏 {country} 列。可在左侧国家列表或顶部标题再次点击恢复。",
    "chart.toastShown": "已恢复 {country} 列。",
    "chart.toastLocked": "至少保留 1 列，当前无法继续隐藏。",
    "footer.disclaimer": "本网站用于教育与研究展示，不构成官方历史定论。",
    "footer.attribution": "署名与引用",
    "footer.sources": "数据来源",
    "footer.privacy": "隐私说明",
    "footer.terms": "使用条款",
    "footer.copyright": "© 2026 ACMFC_LAB / Dankin · Global Dynasties · www.acmfc.fr"
  },
  en: {
    "panel.title": "Control Panel",
    "panel.hint": "All parameters stay on the left while the right chart remains uninterrupted. Toggle columns, granularity, and year focus.",
    "panel.yearFocus": "Year Focus",
    "panel.columns": "Country Columns",
    "panel.selectAll": "Select all",
    "panel.density": "Time Granularity",
    "panel.collapse": "Collapse panel",
    "panel.expand": "Expand panel",
    "panel.prev": "Previous",
    "panel.next": "Next",
    "panel.density.fine": "High detail (40y)",
    "panel.density.medium": "Balanced (60y)",
    "panel.density.coarse": "Overview (100y)",
    "chart.kicker": "Global Parallel Timeline",
    "chart.title": "Waterfall History Matrix",
    "chart.desc": "Each column is a country and each row is a period. Hover to highlight row and column; click a block to inspect global contemporaries.",
    "chart.columnHint": "Tip: Click country labels above to hide/show that column (at least one column remains visible).",
    "chart.mobileHint": "On mobile, swipe horizontally or use the country switcher above for quick navigation.",
    "chart.mobilePrev": "Previous country",
    "chart.mobileNext": "Next country",
    "chart.toastHidden": "{country} column hidden. Click again in header or left country chips to restore.",
    "chart.toastShown": "{country} column restored.",
    "chart.toastLocked": "At least one column must remain visible.",
    "footer.disclaimer": "This website is for educational and research visualization only.",
    "footer.attribution": "Attribution",
    "footer.sources": "Data Sources",
    "footer.privacy": "Privacy",
    "footer.terms": "Terms",
    "footer.copyright": "© 2026 ACMFC_LAB / Dankin · Global Dynasties · www.acmfc.fr"
  },
  fr: {
    "panel.title": "Panneau de contrôle",
    "panel.hint": "Tous les paramètres restent à gauche, sans gêner la lecture du graphique à droite. Ajustez colonnes, granularité et année de focus.",
    "panel.yearFocus": "Année cible",
    "panel.columns": "Colonnes pays",
    "panel.selectAll": "Tout sélectionner",
    "panel.density": "Granularité",
    "panel.collapse": "Réduire le panneau",
    "panel.expand": "Afficher le panneau",
    "panel.prev": "Précédent",
    "panel.next": "Suivant",
    "panel.density.fine": "Détaillé (40 ans)",
    "panel.density.medium": "Équilibré (60 ans)",
    "panel.density.coarse": "Vue large (100 ans)",
    "chart.kicker": "Chronologie mondiale parallèle",
    "chart.title": "Matrice historique en cascade",
    "chart.desc": "Chaque colonne représente un pays et chaque ligne une période. Survolez pour mettre en évidence ligne et colonne; cliquez un bloc pour les contemporains.",
    "chart.columnHint": "Astuce : cliquez les noms de pays en haut pour masquer/afficher une colonne (au moins une colonne reste visible).",
    "chart.mobileHint": "Sur mobile, faites glisser horizontalement ou utilisez le sélecteur de pays ci-dessus.",
    "chart.mobilePrev": "Pays précédent",
    "chart.mobileNext": "Pays suivant",
    "chart.toastHidden": "Colonne {country} masquée. Cliquez encore dans l'en-tête ou à gauche pour la réafficher.",
    "chart.toastShown": "Colonne {country} réaffichée.",
    "chart.toastLocked": "Au moins une colonne doit rester visible.",
    "footer.disclaimer": "Ce site est destiné à la visualisation éducative et de recherche.",
    "footer.attribution": "Attribution",
    "footer.sources": "Sources de données",
    "footer.privacy": "Confidentialité",
    "footer.terms": "Conditions",
    "footer.copyright": "© 2026 ACMFC_LAB / Dankin · Global Dynasties · www.acmfc.fr"
  }
};

const DEFAULT_COUNTRY_ORDER = ["CN", "JP", "IN", "IR", "TR", "RU", "DE", "FR", "EG", "MX", "PE"];
const DEFAULT_LOAD_ROWS = 12;
const LOAD_STEP = 6;

const state = {
  lang: "zh",
  search: "",
  region: "all",
  dynasty: "all",
  year: "",
  loadedCount: DEFAULT_LOAD_ROWS,
  visibleCountries: new Set(DEFAULT_COUNTRY_ORDER),
  panelCollapsed: false,
  mobileCountryFocus: "",
  pendingScroll: false,
  activeDrawerId: null,
  activeDrawerYear: null,
  observer: null
};

const runtime = {
  totalRows: 0,
  hoveredElements: [],
  toastTimer: null,
  rows: [],
  timelineDragged: false
};

const els = {};

document.addEventListener("DOMContentLoaded", function () {
  try {
    init();
  } catch (error) {
    renderFatalState(error);
  }
});

function init() {
  cacheElements();
  hydrateStateFromQuery();
  syncInputsFromState();
  bindEvents();
  renderAll();
}

function renderFatalState(error) {
  console.error(error);
  const root = document.getElementById("timelineFeed");
  if (!root) {
    return;
  }
  root.innerHTML = `<div class="empty-state">页面初始化失败。请按 Ctrl/Cmd + Shift + R 强制刷新后重试。</div>`;
}

function cacheElements() {
  els.layoutRoot = document.getElementById("layoutRoot");
  els.searchInput = document.getElementById("searchInput");
  els.yearInput = document.getElementById("yearInput");
  els.yearSlider = document.getElementById("yearSlider");
  els.jumpYearBtn = document.getElementById("jumpYearBtn");
  els.prevYearBtn = document.getElementById("prevYearBtn");
  els.nextYearBtn = document.getElementById("nextYearBtn");
  els.regionFilter = document.getElementById("regionFilter");
  els.dynastyFilter = document.getElementById("dynastyFilter");
  els.countryChipWrap = document.getElementById("countryChipWrap");
  els.selectAllCountries = document.getElementById("selectAllCountries");
  els.resetFilters = document.getElementById("resetFilters");
  els.panelToggle = document.getElementById("panelToggle");
  els.panelToggleLabel = document.getElementById("panelToggleLabel");
  els.langButtons = Array.from(document.querySelectorAll(".lang-switch button"));
  els.timelineSection = document.getElementById("timelineSection");
  els.countryHeaderWrap = document.getElementById("countryHeaderWrap");
  els.countryHeaderRail = document.getElementById("countryHeaderRail");
  els.countryHeaderTrack = document.getElementById("countryHeaderTrack");
  els.timelineViewport = document.getElementById("timelineViewport");
  els.timelineCanvas = document.getElementById("timelineCanvas");
  els.countryHeader = document.getElementById("countryHeader");
  els.timelineFeed = document.getElementById("timelineFeed");
  els.loadSentinel = document.getElementById("loadSentinel");
  els.timelineEnd = document.getElementById("timelineEnd");
  els.mobileCountryNav = document.getElementById("mobileCountryNav");
  els.mobileCountrySelect = document.getElementById("mobileCountrySelect");
  els.mobilePrevCountry = document.getElementById("mobilePrevCountry");
  els.mobileNextCountry = document.getElementById("mobileNextCountry");
  els.hoverTooltip = document.getElementById("hoverTooltip");
  els.panelToast = document.getElementById("panelToast");
  els.detailDrawer = document.getElementById("detailDrawer");
  els.drawerMask = document.getElementById("drawerMask");
  els.closeDrawer = document.getElementById("closeDrawer");
  els.detailRegion = document.getElementById("detailRegion");
  els.detailTitle = document.getElementById("detailTitle");
  els.detailCountry = document.getElementById("detailCountry");
  els.detailRange = document.getElementById("detailRange");
  els.detailFocusYear = document.getElementById("detailFocusYear");
  els.detailConfidence = document.getElementById("detailConfidence");
  els.detailNote = document.getElementById("detailNote");
  els.detailConcurrent = document.getElementById("detailConcurrent");
  els.detailSources = document.getElementById("detailSources");
}

function hydrateStateFromQuery() {
  const params = new URLSearchParams(window.location.search);

  const lang = params.get("lang");
  const region = params.get("region");
  const dynasty = params.get("dynasty");
  const year = params.get("year");
  const q = params.get("q");
  const cols = params.get("cols");
  const panel = params.get("panel");

  if (["zh", "en", "fr"].includes(lang)) {
    state.lang = lang;
  }
  if (region === "all" || REGION_ORDER.includes(region)) {
    state.region = region;
  }
  if (dynasty && POLITIES.some((item) => item.id === dynasty)) {
    state.dynasty = dynasty;
  }
  if (year !== null && isValidYearInput(year)) {
    state.year = String(parseInt(year, 10));
  }
  if (q) {
    state.search = q;
  }

  if (cols) {
    const selected = cols
      .split(",")
      .map((code) => code.trim())
      .filter((code) => COUNTRIES[code]);
    if (selected.length > 0) {
      state.visibleCountries = new Set(selected);
    }
  }

  if (panel === "collapsed") {
    state.panelCollapsed = true;
  } else if (panel !== "expanded" && window.matchMedia("(max-width: 980px)").matches) {
    state.panelCollapsed = true;
  }

  enforceCountrySelectionForRegion();
}

function bindEvents() {
  els.langButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const lang = button.dataset.lang;
      if (!lang || lang === state.lang) {
        return;
      }
      state.lang = lang;
      renderAll();
    });
  });

  els.panelToggle.addEventListener("click", () => {
    state.panelCollapsed = !state.panelCollapsed;
    applyPanelState();
    syncUrlQuery();
  });

  els.searchInput.addEventListener("input", () => {
    state.search = els.searchInput.value;
    resetFeedWindow();
    renderAll();
  });

  els.yearInput.addEventListener("input", () => {
    const raw = els.yearInput.value.trim();
    if (!raw) {
      state.year = "";
      syncInputsFromState();
      renderAll();
      return;
    }
    if (isValidYearInput(raw)) {
      state.year = String(parseInt(raw, 10));
      syncInputsFromState();
      renderAll();
    }
  });

  els.yearInput.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      applyJumpYear();
    }
  });

  els.jumpYearBtn.addEventListener("click", applyJumpYear);

  els.yearSlider.addEventListener("input", () => {
    state.year = String(parseInt(els.yearSlider.value, 10));
    syncInputsFromState();
    renderAll();
  });

  els.prevYearBtn.addEventListener("click", () => {
    stepFocusYear(-1);
  });
  els.nextYearBtn.addEventListener("click", () => {
    stepFocusYear(1);
  });

  els.regionFilter.addEventListener("change", () => {
    state.region = els.regionFilter.value;
    enforceCountrySelectionForRegion();
    if (state.dynasty !== "all") {
      const found = POLITIES.find((item) => item.id === state.dynasty);
      if (found && found.region !== state.region && state.region !== "all") {
        state.dynasty = "all";
      }
    }
    resetFeedWindow();
    renderAll();
  });

  els.dynastyFilter.addEventListener("change", () => {
    state.dynasty = els.dynastyFilter.value;
    resetFeedWindow();
    renderAll();
  });

  els.selectAllCountries.addEventListener("click", () => {
    getAvailableCountries().forEach((code) => state.visibleCountries.add(code));
    resetFeedWindow();
    renderAll();
  });

  els.countryChipWrap.addEventListener("click", (event) => {
    const chip = event.target.closest("[data-country-chip]");
    if (!chip) {
      return;
    }
    const country = chip.dataset.countryChip;
    if (!country) {
      return;
    }
    const action = toggleCountryColumn(country);
    notifyCountryToggle(country, action);
  });

  if (els.mobileCountrySelect) {
    els.mobileCountrySelect.addEventListener("change", () => {
      const country = els.mobileCountrySelect.value;
      if (!country) {
        return;
      }
      state.mobileCountryFocus = country;
      scrollToCountryColumn(country);
    });
  }

  if (els.mobilePrevCountry) {
    els.mobilePrevCountry.addEventListener("click", () => {
      cycleMobileCountry(-1);
    });
  }

  if (els.mobileNextCountry) {
    els.mobileNextCountry.addEventListener("click", () => {
      cycleMobileCountry(1);
    });
  }

  els.resetFilters.addEventListener("click", () => {
    state.search = "";
    state.region = "all";
    state.dynasty = "all";
    state.year = "";
    state.loadedCount = DEFAULT_LOAD_ROWS;
    state.visibleCountries = new Set(DEFAULT_COUNTRY_ORDER);
    state.mobileCountryFocus = "";
    state.pendingScroll = false;
    closeDrawer();
    syncInputsFromState();
    renderAll();
  });

  els.timelineFeed.addEventListener("click", (event) => {
    if (runtime.timelineDragged) {
      return;
    }
    const block = event.target.closest("[data-polity-id]");
    if (!block) {
      return;
    }
    spawnRipple(block, event);
    const polityId = block.dataset.polityId;
    const contextYear = Number(block.dataset.contextYear);
    openDrawer(polityId, contextYear);
  });

  els.timelineFeed.addEventListener("pointerover", (event) => {
    const block = event.target.closest("[data-polity-id]");
    if (!block) {
      return;
    }
    showHoverTooltip(block, event.clientX, event.clientY);
  });

  els.timelineFeed.addEventListener("pointermove", (event) => {
    if (els.hoverTooltip.classList.contains("hidden")) {
      return;
    }
    placeTooltip(event.clientX, event.clientY);
  });

  els.timelineFeed.addEventListener("pointerout", (event) => {
    const leavingBlock = event.target.closest("[data-polity-id]");
    if (!leavingBlock) {
      return;
    }
    let nextBlock = null;
    const relatedTarget = event.relatedTarget;
    if (relatedTarget && typeof relatedTarget.closest === "function") {
      nextBlock = relatedTarget.closest("[data-polity-id]");
    }
    if (nextBlock) {
      return;
    }
    hideTooltip();
    clearHoverHighlights();
  });

  els.timelineSection.addEventListener("mousemove", (event) => {
    const rect = els.timelineSection.getBoundingClientRect();
    const x = ((event.clientX - rect.left) / rect.width) * 100;
    const y = ((event.clientY - rect.top) / rect.height) * 100;
    els.timelineSection.style.setProperty("--mx", `${clamp(x, 0, 100)}%`);
    els.timelineSection.style.setProperty("--my", `${clamp(y, 0, 100)}%`);
  });

  els.timelineSection.addEventListener("mouseleave", () => {
    hideTooltip();
    clearHoverHighlights();
  });

  els.countryHeader.addEventListener("click", (event) => {
    if (runtime.timelineDragged) {
      return;
    }
    const item = event.target.closest("[data-country-head]");
    if (!item) {
      return;
    }
    const country = item.dataset.countryHead;
    const action = toggleCountryColumn(country);
    notifyCountryToggle(country, action);
  });

  if (els.timelineViewport) {
    let rafId = 0;
    els.timelineViewport.addEventListener(
      "scroll",
      () => {
        if (rafId) {
          cancelAnimationFrame(rafId);
        }
        rafId = requestAnimationFrame(() => {
          syncCountryHeaderScroll();
          syncMobileCountryFromViewport();
        });
      },
      { passive: true }
    );
  }

  bindTimelineViewportDrag();

  els.closeDrawer.addEventListener("click", closeDrawer);
  els.drawerMask.addEventListener("click", closeDrawer);

  window.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      closeDrawer();
      hideTooltip();
    }
  });

  window.addEventListener("resize", () => {
    requestAnimationFrame(() => {
      syncCountryHeaderLayout();
      syncMobileCountryFromViewport();
    });
  });
}

function setupObserver() {
  if (!("IntersectionObserver" in window)) {
    return;
  }

  state.observer = new IntersectionObserver(
    (entries) => {
      const visible = entries.some((entry) => entry.isIntersecting);
      if (!visible) {
        return;
      }
      if (state.loadedCount >= runtime.totalRows) {
        return;
      }
      state.loadedCount += LOAD_STEP;
      renderFeed();
    },
    { rootMargin: "300px 0px" }
  );

  state.observer.observe(els.loadSentinel);
}

function renderAll() {
  applyPanelState();
  applyI18n();
  renderLanguageButtons();
  renderPanelToggleLabel();
  renderFilterOptions();
  renderCountryChips();
  renderFeed();
  syncUrlQuery();

  if (state.activeDrawerId) {
    renderDrawerContent();
  }
}

function applyPanelState() {
  document.body.classList.toggle("panel-collapsed", state.panelCollapsed);
}

function applyI18n() {
  document.title = txt("document.title");
  document.documentElement.lang = state.lang === "zh" ? "zh-Hans" : state.lang;

  document.querySelectorAll("[data-i18n]").forEach((node) => {
    node.textContent = txt(node.dataset.i18n);
  });

  document.querySelectorAll("[data-i18n-placeholder]").forEach((node) => {
    node.placeholder = txt(node.dataset.i18nPlaceholder);
  });

  els.closeDrawer.setAttribute("aria-label", txt("detail.close"));
  if (els.mobilePrevCountry) {
    els.mobilePrevCountry.setAttribute("aria-label", txt("chart.mobilePrev"));
    els.mobilePrevCountry.title = txt("chart.mobilePrev");
  }
  if (els.mobileNextCountry) {
    els.mobileNextCountry.setAttribute("aria-label", txt("chart.mobileNext"));
    els.mobileNextCountry.title = txt("chart.mobileNext");
  }
  if (els.mobileCountrySelect) {
    els.mobileCountrySelect.setAttribute("aria-label", txt("panel.columns"));
  }
}

function renderLanguageButtons() {
  els.langButtons.forEach((button) => {
    const active = button.dataset.lang === state.lang;
    button.classList.toggle("active", active);
    button.setAttribute("aria-pressed", active ? "true" : "false");
  });
}

function renderPanelToggleLabel() {
  els.panelToggleLabel.textContent = state.panelCollapsed ? txt("panel.expand") : txt("panel.collapse");
}

function renderFilterOptions() {
  mountSelect(
    els.regionFilter,
    [{ value: "all", label: txt("filter.allRegions") }, ...REGION_ORDER.map((region) => ({ value: region, label: txt(`region.${region}`) }))],
    state.region
  );

  const availableCountries = new Set(getAvailableCountries());
  const countryOrderIndex = buildCountryOrderIndex();
  const dynastyOptions = POLITIES.filter((item) => availableCountries.has(item.country))
    .sort((a, b) => {
      if (a.start !== b.start) {
        return a.start - b.start;
      }
      const aCountryIndex = countryOrderIndex[a.country] || 999;
      const bCountryIndex = countryOrderIndex[b.country] || 999;
      if (aCountryIndex !== bCountryIndex) {
        return aCountryIndex - bCountryIndex;
      }
      if (a.end !== b.end) {
        return a.end - b.end;
      }
      return localizedPolityName(a).localeCompare(localizedPolityName(b), localeTag());
    })
    .map((item) => ({
      value: item.id,
      label: `${localizedPolityName(item)} · ${localizedCountryName(item.country)} · ${formatRange(item.start, item.end)}`
    }));

  if (state.dynasty !== "all" && !dynastyOptions.some((item) => item.value === state.dynasty)) {
    state.dynasty = "all";
  }

  mountSelect(
    els.dynastyFilter,
    [{ value: "all", label: txt("filter.allDynasties") }, ...dynastyOptions],
    state.dynasty
  );

}

function renderCountryChips() {
  const available = getAvailableCountries();
  const activeCountries = getDisplayCountries();

  const html = available
    .map((code) => {
      const region = (COUNTRIES[code] && COUNTRIES[code].region) || "";
      const isActive = activeCountries.includes(code);
      return `
        <button type="button" class="country-chip ${isActive ? "active" : ""}" data-country-chip="${code}" data-region="${region}">
          <span class="chip-flag" aria-hidden="true">${countryFlagEmoji(code)}</span>
          <span class="chip-name">${localizedCountryName(code)}</span>
        </button>
      `;
    })
    .join("");

  els.countryChipWrap.innerHTML = html;
}

function renderFeed() {
  const model = buildChartModel();

  runtime.totalRows = model.rows.length;
  runtime.rows = model.rows;
  renderCountryHeader(model.countries);
  renderMobileCountryNav(model.countries);

  if (model.rows.length === 0 || model.countries.length === 0) {
    els.timelineFeed.innerHTML = `<div class="empty-state">${txt("timeline.empty")}</div>`;
    els.loadSentinel.classList.add("hidden");
    els.timelineEnd.classList.add("hidden");
    syncCountryHeaderLayout();
    return;
  }

  ensureFocusedRowLoaded(model.rows);
  const visibleRows = model.rows;

  els.timelineFeed.innerHTML = visibleRows.map((row) => renderEraRow(row, model.hasTargetFilter)).join("");

  els.loadSentinel.classList.add("hidden");
  els.timelineEnd.classList.add("hidden");

  if (state.pendingScroll) {
    scrollToFocusedRow();
    state.pendingScroll = false;
  }

  requestAnimationFrame(() => {
    syncCountryHeaderLayout();
    syncMobileCountryFromViewport();
  });
}

function renderCountryHeader(countries) {
  if (countries.length === 0) {
    els.countryHeader.innerHTML = "";
    if (els.timelineCanvas) {
      els.timelineCanvas.style.setProperty("--col-count", "1");
    }
    if (els.countryHeaderTrack) {
      els.countryHeaderTrack.style.width = "100%";
      els.countryHeaderTrack.style.transform = "translateX(0px)";
    }
    return;
  }

  if (els.timelineCanvas) {
    els.timelineCanvas.style.setProperty("--col-count", String(countries.length));
  }
  els.countryHeader.style.setProperty("--col-count", String(countries.length));
  const html = countries
    .map((code) => {
      const region = COUNTRIES[code] ? COUNTRIES[code].region : "";
      return `
        <button class="country-head-item" type="button" data-country-head="${code}" data-country="${code}">
          <div class="country-head-main">
            <span class="country-flag" aria-hidden="true">${countryFlagEmoji(code)}</span>
            <p>${localizedCountryName(code)}</p>
            <span class="country-code-badge" aria-hidden="true">${code}</span>
          </div>
          <span class="country-head-region">${regionMarkHtml(region, "region-mark-sm")}${txt(`region.${region}`)}</span>
        </button>
      `;
    })
    .join("");

  els.countryHeader.innerHTML = html;
}

function syncCountryHeaderLayout() {
  if (!els.countryHeaderTrack || !els.timelineViewport) {
    return;
  }

  let width = 0;
  const firstLaneRow = els.timelineFeed ? els.timelineFeed.querySelector(".era-lanes") : null;
  if (firstLaneRow) {
    width = firstLaneRow.scrollWidth;
  } else {
    const vars = getComputedStyle(document.documentElement);
    const labelWidth = parseFloat(vars.getPropertyValue("--era-label-w")) || 0;
    width = Math.max(0, els.timelineViewport.scrollWidth - labelWidth - 10);
  }

  if (width > 0) {
    els.countryHeaderTrack.style.width = `${width}px`;
  } else {
    els.countryHeaderTrack.style.width = "100%";
  }

  syncCountryHeaderScroll();
}

function syncCountryHeaderScroll() {
  if (!els.countryHeaderTrack || !els.timelineViewport) {
    return;
  }
  const x = Math.round(els.timelineViewport.scrollLeft);
  els.countryHeaderTrack.style.transform = `translate3d(${-x}px, 0, 0)`;
}

function renderMobileCountryNav(countries) {
  if (!els.mobileCountryNav || !els.mobileCountrySelect) {
    return;
  }

  if (!countries || countries.length === 0) {
    els.mobileCountryNav.classList.add("hidden");
    els.mobileCountrySelect.innerHTML = "";
    state.mobileCountryFocus = "";
    return;
  }

  if (!countries.includes(state.mobileCountryFocus)) {
    state.mobileCountryFocus = countries[0];
  }

  const html = countries
    .map((code) => `<option value="${code}">${countryFlagEmoji(code)} ${localizedCountryName(code)}</option>`)
    .join("");

  els.mobileCountrySelect.innerHTML = html;
  els.mobileCountrySelect.value = state.mobileCountryFocus;
  els.mobileCountryNav.classList.remove("hidden");
}

function cycleMobileCountry(direction) {
  const countries = getDisplayCountries();
  if (countries.length === 0) {
    return;
  }

  let index = countries.indexOf(state.mobileCountryFocus);
  if (index < 0) {
    index = 0;
  }

  const next = countries[positiveMod(index + direction, countries.length)];
  state.mobileCountryFocus = next;
  if (els.mobileCountrySelect) {
    els.mobileCountrySelect.value = next;
  }
  scrollToCountryColumn(next);
}

function scrollToCountryColumn(country, behavior = "smooth") {
  if (!els.timelineViewport || !els.countryHeader || !country) {
    return;
  }
  const head = els.countryHeader.querySelector(`[data-country-head="${country}"]`);
  if (!head) {
    return;
  }

  const viewportRect = els.timelineViewport.getBoundingClientRect();
  const headRect = head.getBoundingClientRect();
  const targetLeft =
    els.timelineViewport.scrollLeft +
    (headRect.left - viewportRect.left) -
    (els.timelineViewport.clientWidth - headRect.width) / 2;
  const maxScroll = Math.max(0, els.timelineViewport.scrollWidth - els.timelineViewport.clientWidth);
  const nextLeft = clamp(targetLeft, 0, maxScroll);
  els.timelineViewport.scrollTo({ left: nextLeft, behavior });
  if (behavior === "auto") {
    syncCountryHeaderScroll();
  }
}

function syncMobileCountryFromViewport() {
  if (!els.timelineViewport || !els.mobileCountrySelect || !els.countryHeader) {
    return;
  }

  const heads = Array.from(els.countryHeader.querySelectorAll("[data-country-head]"));
  if (heads.length === 0) {
    return;
  }

  const viewportRect = els.timelineViewport.getBoundingClientRect();
  const anchorX = viewportRect.left + Math.min(viewportRect.width * 0.62, viewportRect.width - 18);
  let closest = null;
  let minDist = Number.POSITIVE_INFINITY;

  heads.forEach((node) => {
    const rect = node.getBoundingClientRect();
    const center = rect.left + rect.width / 2;
    const dist = Math.abs(center - anchorX);
    if (dist < minDist) {
      minDist = dist;
      closest = node.dataset.countryHead || null;
    }
  });

  if (!closest) {
    return;
  }

  state.mobileCountryFocus = closest;
  if (els.mobileCountrySelect.value !== closest) {
    els.mobileCountrySelect.value = closest;
  }
}

function bindTimelineViewportDrag() {
  if (!els.timelineViewport) {
    return;
  }

  let pointerId = null;
  let startX = 0;
  let startLeft = 0;
  let moved = false;

  const endDrag = (event) => {
    if (pointerId === null) {
      return;
    }
    if (event && event.pointerId !== pointerId) {
      return;
    }

    pointerId = null;
    els.timelineViewport.classList.remove("is-dragging");
    runtime.timelineDragged = moved;
    moved = false;

    window.setTimeout(() => {
      runtime.timelineDragged = false;
    }, 60);
  };

  els.timelineViewport.addEventListener("pointerdown", (event) => {
    if (event.pointerType !== "mouse" || event.button !== 0) {
      return;
    }

    pointerId = event.pointerId;
    startX = event.clientX;
    startLeft = els.timelineViewport.scrollLeft;
    moved = false;
    runtime.timelineDragged = false;
    els.timelineViewport.classList.add("is-dragging");

    if (typeof els.timelineViewport.setPointerCapture === "function") {
      try {
        els.timelineViewport.setPointerCapture(pointerId);
      } catch (error) {
        // No-op: browsers may reject capture for certain input states.
      }
    }
  });

  els.timelineViewport.addEventListener("pointermove", (event) => {
    if (pointerId === null || event.pointerId !== pointerId) {
      return;
    }

    const delta = event.clientX - startX;
    if (Math.abs(delta) > 4) {
      moved = true;
    }
    els.timelineViewport.scrollLeft = startLeft - delta;

    if (moved) {
      event.preventDefault();
    }
  });

  els.timelineViewport.addEventListener("pointerup", endDrag);
  els.timelineViewport.addEventListener("pointercancel", endDrag);
  els.timelineViewport.addEventListener("lostpointercapture", endDrag);
}

function renderEraRow(row, hasTargetFilter) {
  const year = getFocusYear();
  const isFocus = year !== null && year >= row.start && year <= row.end;
  const density = Math.round((row.activeCount / Math.max(1, row.lanes.length)) * 100);

  const lanes = row.lanes
    .map((lane) => {
      if (!lane.polity) {
        return `<div class="lane-slot" data-country="${lane.country}"><div class="lane-empty" data-country="${lane.country}"></div></div>`;
      }

      const classNames = ["dynasty-block"];
      if (lane.joinTop) {
        classNames.push("join-top");
      }
      if (lane.joinBottom) {
        classNames.push("join-bottom");
      }
      if (hasTargetFilter && !lane.matchPrimary) {
        classNames.push("is-dim");
      }
      if (lane.matchPrimary) {
        classNames.push("is-match");
      }

      const provisionalYear = year !== null ? year : Math.floor((row.start + row.end) / 2);
      const contextYear = clamp(provisionalYear, lane.polity.start, lane.polity.end);
      const extra = lane.extraCount > 0 ? `<span class="block-extra">+${lane.extraCount}</span>` : "";
      const colorStyle = dynastyColorStyle(lane.polity);
      const flag = countryFlagEmoji(lane.polity.country);
      const order = DYNASTY_ORDER_CACHE[lane.polity.id] || "";

      return `
        <div class="lane-slot" data-country="${lane.country}">
          <button
            type="button"
            class="${classNames.join(" ")}"
            style="${colorStyle}"
            data-polity-id="${lane.polity.id}"
            data-country="${lane.country}"
            data-region="${lane.polity.region}"
            data-context-year="${contextYear}"
            data-era-start="${row.start}"
            data-era-end="${row.end}"
          >
            ${extra}
            <div class="block-top-meta">
              <span class="block-flag" aria-hidden="true">${flag}</span>
              <span class="block-glyph" aria-hidden="true">${regionMarkHtml(lane.polity.region, "region-mark-xs")}</span>
              <span class="block-order" aria-hidden="true">${order}</span>
            </div>
            <p class="block-name">${localizedPolityName(lane.polity)}</p>
            <p class="block-meta">${localizedCountryName(lane.polity.country)}</p>
          </button>
        </div>
      `;
    })
    .join("");

  return `
    <article class="era-row ${isFocus ? "focus-row" : ""}" id="era-${row.start}" data-era-start="${row.start}">
      <div class="era-label">
        <p class="era-text">${formatRange(row.start, row.end)}</p>
        <p class="era-meta">${row.activeCount} ${txt("timeline.records")} · ${density}%</p>
        <div class="era-density" aria-hidden="true"><span style="width:${density}%"></span></div>
      </div>
      <div class="era-lanes" style="--col-count:${row.lanes.length}">
        ${lanes}
      </div>
    </article>
  `;
}

function buildChartModel() {
  const countries = getDisplayCountries();
  const hasTargetFilter = Boolean(state.search.trim() || state.dynasty !== "all");
  const query = normalize(state.search.trim());

  const basePolities = POLITIES.filter((item) => countries.includes(item.country));
  const boundaries = getChangeBoundaries(basePolities);

  const matchFn = (item) => {
    if (state.dynasty !== "all" && item.id !== state.dynasty) {
      return false;
    }
    if (!query) {
      return true;
    }
    const countryNames = COUNTRIES[item.country] ? COUNTRIES[item.country].names : {};
    const notes = item.note || {};
    const bucket = [
      item.name.zh,
      item.name.en,
      item.name.fr,
      notes.zh,
      notes.en,
      notes.fr,
      countryNames.zh,
      countryNames.en,
      countryNames.fr,
      txt(`region.${item.region}`)
    ]
      .filter(Boolean)
      .join(" ");

    return normalize(bucket).includes(query);
  };

  const rows = [];
  for (let index = 0; index < boundaries.length - 1; index += 1) {
    const start = boundaries[index];
    const end = boundaries[index + 1] - 1;
    if (end < start) {
      continue;
    }

    const lanes = countries.map((country) => buildLane(country, start, end, basePolities, matchFn));
    const activeCount = lanes.filter((lane) => lane.polity).length;

    if (activeCount === 0) {
      continue;
    }

    if (hasTargetFilter && !lanes.some((lane) => lane.hasMatch)) {
      continue;
    }

    rows.push({ start, end, lanes, activeCount });
  }

  for (let index = 0; index < rows.length; index += 1) {
    const row = rows[index];
    row.lanes.forEach((lane, laneIndex) => {
      if (!lane.polity) {
        return;
      }
      const prevRow = rows[index - 1];
      const nextRow = rows[index + 1];
      const prev = prevRow && prevRow.lanes[laneIndex] ? prevRow.lanes[laneIndex].polity : null;
      const next = nextRow && nextRow.lanes[laneIndex] ? nextRow.lanes[laneIndex].polity : null;
      lane.joinTop = Boolean(prev && prev.id === lane.polity.id);
      lane.joinBottom = Boolean(next && next.id === lane.polity.id);
    });
  }

  return { countries, rows, hasTargetFilter };
}

function getChangeBoundaries(basePolities) {
  const points = new Set([ERA_MIN, ERA_MAX + 1]);

  basePolities.forEach((item) => {
    const start = clamp(item.start, ERA_MIN, ERA_MAX + 1);
    const endPlusOne = clamp(item.end + 1, ERA_MIN, ERA_MAX + 1);
    points.add(start);
    points.add(endPlusOne);
  });

  return [...points].sort((a, b) => a - b);
}

function buildLane(country, start, end, basePolities, matchFn) {
  const candidates = basePolities.filter((item) => item.country === country && rangesOverlap(item.start, item.end, start, end));
  if (candidates.length === 0) {
    return { country, polity: null, hasMatch: false, matchPrimary: false, extraCount: 0, joinTop: false, joinBottom: false };
  }

  const weighted = candidates
    .map((item) => ({
      item,
      match: matchFn(item),
      overlap: overlapYears(item.start, item.end, start, end),
      coverage: overlapYears(item.start, item.end, start, end) / Math.max(1, item.end - item.start + 1)
    }))
    .sort((a, b) => {
      const byMatch = Number(b.match) - Number(a.match);
      if (byMatch !== 0) {
        return byMatch;
      }
      if (b.coverage !== a.coverage) {
        return b.coverage - a.coverage;
      }
      if (b.overlap !== a.overlap) {
        return b.overlap - a.overlap;
      }
      return a.item.start - b.item.start;
    });

  const primary = weighted[0].item;
  return {
    country,
    polity: primary,
    hasMatch: weighted.some((entry) => entry.match),
    matchPrimary: matchFn(primary),
    extraCount: Math.max(0, candidates.length - 1),
    joinTop: false,
    joinBottom: false
  };
}

function enforceCountrySelectionForRegion() {
  const available = getAvailableCountries();
  const availableSet = new Set(available);

  state.visibleCountries.forEach((code) => {
    if (!availableSet.has(code)) {
      state.visibleCountries.delete(code);
    }
  });

  if (state.visibleCountries.size === 0) {
    available.forEach((code) => state.visibleCountries.add(code));
  }
}

function getAvailableCountries() {
  return DEFAULT_COUNTRY_ORDER.filter((code) => {
    if (!COUNTRIES[code]) {
      return false;
    }
    if (state.region === "all") {
      return true;
    }
    return COUNTRIES[code].region === state.region;
  });
}

function getDisplayCountries() {
  const available = getAvailableCountries();
  const selected = available.filter((code) => state.visibleCountries.has(code));
  if (selected.length > 0) {
    return selected;
  }
  available.forEach((code) => state.visibleCountries.add(code));
  return available;
}

function toggleCountryColumn(code) {
  const available = new Set(getAvailableCountries());
  if (!available.has(code)) {
    return "none";
  }

  let action = "none";
  if (state.visibleCountries.has(code) && getDisplayCountries().length > 1) {
    state.visibleCountries.delete(code);
    action = "hidden";
  } else {
    if (state.visibleCountries.has(code)) {
      action = "locked";
    } else {
      state.visibleCountries.add(code);
      action = "shown";
    }
  }

  resetFeedWindow();
  renderAll();
  return action;
}

function notifyCountryToggle(countryCode, action) {
  if (!countryCode || action === "none") {
    return;
  }

  if (action === "hidden") {
    showPanelToast(txt("chart.toastHidden", { country: localizedCountryName(countryCode) }));
    return;
  }

  if (action === "shown") {
    showPanelToast(txt("chart.toastShown", { country: localizedCountryName(countryCode) }));
    return;
  }

  if (action === "locked") {
    showPanelToast(txt("chart.toastLocked"));
  }
}

function showPanelToast(message) {
  if (!els.panelToast) {
    return;
  }
  els.panelToast.textContent = message;
  els.panelToast.classList.remove("hidden");

  if (runtime.toastTimer) {
    window.clearTimeout(runtime.toastTimer);
  }
  runtime.toastTimer = window.setTimeout(() => {
    els.panelToast.classList.add("hidden");
  }, 2200);
}

function applyJumpYear() {
  const raw = els.yearInput.value.trim();
  if (!raw) {
    state.year = "";
    state.pendingScroll = false;
    syncInputsFromState();
    renderAll();
    return;
  }

  if (!isValidYearInput(raw)) {
    return;
  }

  state.year = String(parseInt(raw, 10));
  state.pendingScroll = true;
  syncInputsFromState();
  renderAll();
}

function ensureFocusedRowLoaded(rows) {
  const year = getFocusYear();
  if (year === null) {
    return;
  }

  const index = rows.findIndex((row) => year >= row.start && year <= row.end);
  if (index < 0) {
    return;
  }

  const targetCount = index + 4;
  if (state.loadedCount < targetCount) {
    state.loadedCount = targetCount;
  }
}

function scrollToFocusedRow() {
  const year = getFocusYear();
  if (year === null) {
    return;
  }

  const targetRow = (runtime.rows || []).find((row) => year >= row.start && year <= row.end);
  if (!targetRow) {
    return;
  }

  const row = document.getElementById(`era-${targetRow.start}`);
  if (!row) {
    return;
  }

  requestAnimationFrame(() => {
    row.scrollIntoView({ behavior: "smooth", block: "center" });
  });
}

function stepFocusYear(direction) {
  const rows = runtime.rows || [];
  if (rows.length === 0) {
    return;
  }

  const current = getFocusYear();
  let targetIndex = 0;

  if (current === null) {
    targetIndex = direction > 0 ? 0 : rows.length - 1;
  } else {
    const currentIndex = rows.findIndex((row) => current >= row.start && current <= row.end);
    if (currentIndex === -1) {
      targetIndex = direction > 0 ? 0 : rows.length - 1;
    } else {
      targetIndex = clamp(currentIndex + direction, 0, rows.length - 1);
    }
  }

  state.year = String(rows[targetIndex].start);
  state.pendingScroll = true;
  syncInputsFromState();
  renderAll();
}

function showHoverTooltip(block, x, y) {
  const polity = POLITIES.find((item) => item.id === block.dataset.polityId);
  if (!polity) {
    return;
  }
  const colorStyle = dynastyColorStyle(polity);

  const html = `
    <div class="tip-head">
      <span class="tip-flag" aria-hidden="true">${countryFlagEmoji(polity.country)}</span>
      <strong>${localizedPolityName(polity)}</strong>
      <span class="tip-glyph" aria-hidden="true">${regionMarkHtml(polity.region, "region-mark-sm")}</span>
    </div>
    <div>${localizedCountryName(polity.country)} · ${txt(`region.${polity.region}`)}</div>
    <div>${formatRange(polity.start, polity.end)}</div>
    <span class="tip-swatch" style="${colorStyle}" aria-hidden="true"></span>
  `;

  els.hoverTooltip.innerHTML = html;
  els.hoverTooltip.classList.remove("hidden");
  placeTooltip(x, y);

  const country = block.dataset.country;
  const row = block.closest(".era-row");
  applyHoverHighlights(country, row);
}

function placeTooltip(x, y) {
  const tooltip = els.hoverTooltip;
  const margin = 14;
  const maxX = window.innerWidth - tooltip.offsetWidth - margin;
  const maxY = window.innerHeight - tooltip.offsetHeight - margin;
  const nextX = clamp(x + 18, margin, maxX);
  const nextY = clamp(y + 18, margin, maxY);
  tooltip.style.left = `${nextX}px`;
  tooltip.style.top = `${nextY}px`;
}

function hideTooltip() {
  els.hoverTooltip.classList.add("hidden");
}

function applyHoverHighlights(country, rowElement) {
  clearHoverHighlights();

  if (!country) {
    return;
  }

  document.querySelectorAll(`[data-country="${country}"]`).forEach((node) => {
    node.classList.add("col-hover");
    runtime.hoveredElements.push(node);
  });

  const head = els.countryHeader.querySelector(`[data-country-head="${country}"]`);
  if (head) {
    head.classList.add("col-hover");
    runtime.hoveredElements.push(head);
  }

  if (rowElement) {
    rowElement.classList.add("row-hover");
    runtime.hoveredElements.push(rowElement);
  }
}

function clearHoverHighlights() {
  runtime.hoveredElements.forEach((node) => {
    node.classList.remove("col-hover", "row-hover");
  });
  runtime.hoveredElements = [];
}

function spawnRipple(target, event) {
  const rect = target.getBoundingClientRect();
  const ripple = document.createElement("span");
  ripple.className = "ripple";
  ripple.style.left = `${event.clientX - rect.left}px`;
  ripple.style.top = `${event.clientY - rect.top}px`;
  target.appendChild(ripple);
  ripple.addEventListener("animationend", () => ripple.remove());
}

function openDrawer(polityId, contextYear) {
  state.activeDrawerId = polityId;
  state.activeDrawerYear = Number.isFinite(contextYear) ? contextYear : null;
  renderDrawerContent();

  els.detailDrawer.classList.add("open");
  els.detailDrawer.setAttribute("aria-hidden", "false");
  els.drawerMask.classList.remove("hidden");
  els.drawerMask.setAttribute("aria-hidden", "false");
}

function closeDrawer() {
  state.activeDrawerId = null;
  state.activeDrawerYear = null;
  els.detailDrawer.classList.remove("open");
  els.detailDrawer.setAttribute("aria-hidden", "true");
  els.drawerMask.classList.add("hidden");
  els.drawerMask.setAttribute("aria-hidden", "true");
}

function renderDrawerContent() {
  const polity = POLITIES.find((item) => item.id === state.activeDrawerId);
  if (!polity) {
    closeDrawer();
    return;
  }

  let tentativeYear = getFocusYear();
  if (tentativeYear === null || tentativeYear === undefined) {
    tentativeYear = state.activeDrawerYear;
  }
  if (tentativeYear === null || tentativeYear === undefined) {
    tentativeYear = Math.floor((polity.start + polity.end) / 2);
  }
  const focusYear = clamp(tentativeYear, polity.start, polity.end);
  const sourceItems = getPolitySources(polity);
  const evidence = confidenceLabel(getPolityMeta(polity).confidence);

  const countriesInScope = getAvailableCountries();
  const concurrentGroups = collectConcurrentGroupsForRange(polity, countriesInScope, focusYear);

  els.detailRegion.textContent = `${txt("detail.region")}: ${txt(`region.${polity.region}`)}`;
  els.detailTitle.textContent = `${countryFlagEmoji(polity.country)} ${localizedPolityName(polity)}`;
  els.detailCountry.textContent = `${txt("detail.country")}: ${countryFlagEmoji(polity.country)} ${localizedCountryName(polity.country)}`;
  els.detailRange.textContent = `${txt("detail.period")}: ${formatRange(polity.start, polity.end)}`;
  els.detailFocusYear.textContent = `${txt("detail.focusYear")}: ${formatYear(focusYear)}`;
  els.detailConfidence.textContent = `${txt("detail.evidence")}: ${evidence}`;
  els.detailNote.textContent = localizedValue(polity.note);

  els.detailConcurrent.classList.add("concurrent-tree");
  els.detailConcurrent.innerHTML = "";
  if (concurrentGroups.length === 0) {
    const li = document.createElement("li");
    li.textContent = txt("detail.none");
    els.detailConcurrent.appendChild(li);
  } else {
    concurrentGroups.forEach((regionGroup) => {
      const regionLi = document.createElement("li");
      regionLi.className = "concurrent-region-item";

      const regionTitle = document.createElement("p");
      regionTitle.className = "concurrent-region-title";
      regionTitle.innerHTML = `${regionMarkHtml(regionGroup.region, "region-mark-sm")} ${txt(`region.${regionGroup.region}`)} · ${txt("detail.countryCount", { count: regionGroup.countries.length })}`;
      regionLi.appendChild(regionTitle);

      regionGroup.countries.forEach((countryGroup) => {
        const countryBlock = document.createElement("div");
        countryBlock.className = "concurrent-country-block";

        const countryTitle = document.createElement("p");
        countryTitle.className = "concurrent-country-title";
        countryTitle.textContent = `${countryFlagEmoji(countryGroup.country)} ${localizedCountryName(countryGroup.country)}`;
        countryBlock.appendChild(countryTitle);

        const polityList = document.createElement("ul");
        polityList.className = "concurrent-polity-list";

        countryGroup.items.forEach((entry) => {
          const li = document.createElement("li");
          li.className = "concurrent-polity-item";
          const conf = getPolityMeta(entry.polity).confidence || "high";
          const confText = conf === "high" ? "" : ` · ${confidenceLabel(conf)}`;
          const focusText = entry.includesFocus ? ` · ${txt("detail.includesFocus")}` : "";
          li.textContent = `${localizedPolityName(entry.polity)} · ${formatRange(entry.polity.start, entry.polity.end)} · ${txt("detail.overlap")}: ${formatRange(entry.overlapStart, entry.overlapEnd)}${focusText}${confText}`;
          polityList.appendChild(li);
        });

        countryBlock.appendChild(polityList);
        regionLi.appendChild(countryBlock);
      });

      els.detailConcurrent.appendChild(regionLi);
    });
  }

  els.detailSources.innerHTML = "";
  sourceItems.forEach((source) => {
    const li = document.createElement("li");
    const anchor = document.createElement("a");
    anchor.href = source.url;
    anchor.target = "_blank";
    anchor.rel = "noreferrer noopener";
    anchor.textContent = source.label;
    li.appendChild(anchor);
    els.detailSources.appendChild(li);
  });
}

function getPolityMeta(polity) {
  return POLITY_META[polity.id] || { confidence: "high", sources: COUNTRY_SOURCE_MAP[polity.country] || [] };
}

function confidenceLabel(confidence) {
  return txt(`confidence.${confidence || "high"}`);
}

function confidenceWeight(polity) {
  const confidence = getPolityMeta(polity).confidence || "high";
  return CONFIDENCE_WEIGHT[confidence] || 0;
}

function collectConcurrentGroupsForRange(selectedPolity, countriesInScope, focusYear) {
  const regionRank = {};
  REGION_ORDER.forEach((region, index) => {
    regionRank[region] = index;
  });
  const countryRank = buildCountryOrderIndex();
  const bucket = {};

  countriesInScope.forEach((country) => {
    if (country === selectedPolity.country) {
      return;
    }

    const overlaps = POLITIES.filter((item) => {
      if (item.country !== country) {
        return false;
      }
      if (item.id === selectedPolity.id) {
        return false;
      }
      return rangesOverlap(item.start, item.end, selectedPolity.start, selectedPolity.end);
    }).sort((a, b) => {
      if (a.start !== b.start) {
        return a.start - b.start;
      }
      if (a.end !== b.end) {
        return a.end - b.end;
      }
      return confidenceWeight(b) - confidenceWeight(a);
    });

    if (overlaps.length === 0) {
      return;
    }

    const region = COUNTRIES[country] ? COUNTRIES[country].region : "asia";
    if (!bucket[region]) {
      bucket[region] = [];
    }

    bucket[region].push({
      country,
      items: overlaps.map((item) => ({
        polity: item,
        overlapStart: Math.max(item.start, selectedPolity.start),
        overlapEnd: Math.min(item.end, selectedPolity.end),
        includesFocus: isActiveAtYear(item, focusYear)
      }))
    });
  });

  return Object.keys(bucket)
    .sort((a, b) => {
      const rankA = Object.prototype.hasOwnProperty.call(regionRank, a) ? regionRank[a] : 99;
      const rankB = Object.prototype.hasOwnProperty.call(regionRank, b) ? regionRank[b] : 99;
      return rankA - rankB;
    })
    .map((region) => ({
      region,
      countries: bucket[region].sort((a, b) => {
        const rankA = Object.prototype.hasOwnProperty.call(countryRank, a.country) ? countryRank[a.country] : 999;
        const rankB = Object.prototype.hasOwnProperty.call(countryRank, b.country) ? countryRank[b.country] : 999;
        if (rankA !== rankB) {
          return rankA - rankB;
        }
        return localizedCountryName(a.country).localeCompare(localizedCountryName(b.country), localeTag());
      })
    }));
}

function getPolitySources(polity) {
  const meta = getPolityMeta(polity);
  const sourceIds = [...(meta.sources || []), ...(COUNTRY_SOURCE_MAP[polity.country] || [])];
  const uniqueIds = [...new Set(sourceIds)];

  return uniqueIds
    .map((id) => SOURCE_CATALOG[id])
    .filter(Boolean);
}

function syncInputsFromState() {
  els.searchInput.value = state.search;
  els.yearInput.value = state.year;
  const sliderYear = state.year === "" ? 0 : clamp(parseInt(state.year, 10), ERA_MIN, ERA_MAX);
  els.yearSlider.value = String(sliderYear);
}

function resetFeedWindow() {
  state.loadedCount = DEFAULT_LOAD_ROWS;
  state.pendingScroll = false;
}

function mountSelect(select, options, value) {
  const fragment = document.createDocumentFragment();
  options.forEach((item) => {
    const option = document.createElement("option");
    option.value = item.value;
    option.textContent = item.label;
    fragment.appendChild(option);
  });
  select.innerHTML = "";
  select.appendChild(fragment);
  select.value = value;
}

function localizedPolityName(item) {
  return localizedValue(item.name);
}

function localizedCountryName(code) {
  const country = COUNTRIES[code];
  return localizedValue(country ? country.names : null, code);
}

function localizedValue(valueMap, fallback = "") {
  if (!valueMap || typeof valueMap !== "object") {
    return fallback;
  }
  return valueMap[state.lang] || valueMap.en || valueMap.zh || valueMap.fr || fallback;
}

function countryFlagEmoji(code) {
  return COUNTRY_FLAGS[code] || "🏳️";
}

function regionMarkHtml(region, sizeClass) {
  const normalizedRegion = REGION_ORDER.includes(region) ? region : "asia";
  const cls = sizeClass || "region-mark-sm";
  return `<span class="region-mark ${cls} region-${normalizedRegion}"></span>`;
}

function buildCountryOrderIndex() {
  const order = {};
  Object.keys(COUNTRIES).forEach((code, index) => {
    order[code] = index;
  });
  return order;
}

function buildDynastyOrderCache() {
  const grouped = {};
  const map = {};

  POLITIES.forEach((item) => {
    if (!grouped[item.country]) {
      grouped[item.country] = [];
    }
    grouped[item.country].push(item);
  });

  Object.keys(grouped).forEach((country) => {
    const list = grouped[country].slice().sort((a, b) => {
      if (a.start !== b.start) {
        return a.start - b.start;
      }
      if (a.end !== b.end) {
        return a.end - b.end;
      }
      return String(a.id).localeCompare(String(b.id), "en-US");
    });

    list.forEach((item, index) => {
      map[item.id] = index + 1;
    });
  });

  return map;
}

function buildDynastyColorCache() {
  const grouped = {};
  const map = {};

  POLITIES.forEach((item) => {
    if (!grouped[item.country]) {
      grouped[item.country] = [];
    }
    grouped[item.country].push(item);
  });

  Object.keys(grouped).forEach((country) => {
    const list = grouped[country].slice().sort((a, b) => {
      if (a.start !== b.start) {
        return a.start - b.start;
      }
      if (a.end !== b.end) {
        return a.end - b.end;
      }
      return String(a.id).localeCompare(String(b.id), "en-US");
    });

    list.forEach((item, index) => {
      map[item.id] = deriveDynastyColor(country, item.id, index);
    });
  });

  return map;
}

function deriveDynastyColor(country, polityId, index) {
  const baseHue = COUNTRY_CULTURE_HUE[country] || 214;
  const hash = hashCode(polityId);
  const hueNudge = ((index % 5) - 2) * 3 + ((hash % 5) - 2);
  const satNudge = ((index * 5 + hash) % 9) - 4;
  const lightNudge = ((index * 3 + hash) % 7) - 3;

  const hue = positiveMod(baseHue + hueNudge, 360);
  const sat = clamp(38 + satNudge, 30, 50);
  const light = clamp(82 + lightNudge, 76, 90);

  return {
    h: hue,
    s: sat,
    l: light
  };
}

function dynastyColorStyle(polity) {
  const base = DYNASTY_COLOR_CACHE[polity.id] || deriveDynastyColor(polity.country, polity.id, 0);
  const h2 = base.h;
  const h3 = base.h;
  const s2 = base.s;
  const l2 = base.l;
  const l3 = base.l;
  const angle = 0;
  const useDarkText = base.l >= 68;
  const text = useDarkText ? "#10233f" : "#f7fbff";
  const meta = useDarkText ? "rgba(16, 35, 63, 0.82)" : "rgba(247, 251, 255, 0.9)";
  const badgeBg = useDarkText ? "rgba(255, 255, 255, 0.86)" : "rgba(8, 16, 30, 0.3)";
  const badgeText = useDarkText ? "rgba(16, 31, 52, 0.86)" : "rgba(246, 251, 255, 0.95)";
  const border = `hsla(${base.h}, ${clamp(base.s + 8, 34, 58)}%, ${clamp(base.l - 22, 44, 70)}%, 0.62)`;

  return [
    `--dyn-h:${base.h}`,
    `--dyn-s:${base.s}`,
    `--dyn-l:${base.l}`,
    `--dyn-h2:${h2}`,
    `--dyn-s2:${s2}`,
    `--dyn-l2:${l2}`,
    `--dyn-h3:${h3}`,
    `--dyn-l3:${l3}`,
    `--dyn-angle:${angle}deg`,
    `--dyn-text:${text}`,
    `--dyn-meta:${meta}`,
    `--dyn-badge-bg:${badgeBg}`,
    `--dyn-badge-text:${badgeText}`,
    `--dyn-border:${border}`
  ].join(";") + ";";
}

function hashCode(text) {
  let hash = 0;
  const src = String(text || "");
  for (let index = 0; index < src.length; index += 1) {
    hash = ((hash << 5) - hash + src.charCodeAt(index)) | 0;
  }
  return Math.abs(hash);
}

function positiveMod(value, base) {
  return ((value % base) + base) % base;
}

function txt(key, vars = {}) {
  const merged = {
    ...(UI[state.lang] || UI.zh),
    ...(EXTRA_UI[state.lang] || EXTRA_UI.zh)
  };
  const mergedEn = {
    ...(UI.en || {}),
    ...(EXTRA_UI.en || {})
  };

  let content = merged[key] || mergedEn[key] || key;
  Object.entries(vars).forEach(([name, value]) => {
    content = content.replace(`{${name}}`, String(value));
  });
  return content;
}

function localeTag() {
  if (state.lang === "zh") {
    return "zh-CN";
  }
  if (state.lang === "fr") {
    return "fr-FR";
  }
  return "en-US";
}

function formatRange(start, end) {
  return `${formatYear(start)} - ${formatYear(end)}`;
}

function formatYear(year) {
  if (state.lang === "zh") {
    return year < 0 ? `${txt("era.bce")}${Math.abs(year)}` : `${txt("era.ce")}${year}`;
  }
  return year < 0 ? `${Math.abs(year)} ${txt("era.bce")}` : `${year} ${txt("era.ce")}`;
}

function isValidYearInput(raw) {
  const parsed = parseInt(raw, 10);
  return Number.isInteger(parsed) && parsed >= -20000 && parsed <= 3000;
}

function getFocusYear() {
  if (state.year === "") {
    return null;
  }
  if (!isValidYearInput(String(state.year))) {
    return null;
  }
  return parseInt(state.year, 10);
}

function isActiveAtYear(item, year) {
  return item.start <= year && year <= item.end;
}

function rangesOverlap(aStart, aEnd, bStart, bEnd) {
  return aStart <= bEnd && bStart <= aEnd;
}

function overlapYears(aStart, aEnd, bStart, bEnd) {
  if (!rangesOverlap(aStart, aEnd, bStart, bEnd)) {
    return 0;
  }
  return Math.min(aEnd, bEnd) - Math.max(aStart, bStart) + 1;
}

function normalize(text) {
  return String(text || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

function clamp(value, min, max) {
  return Math.max(min, Math.min(max, value));
}

function syncUrlQuery() {
  const params = new URLSearchParams();

  if (state.lang !== "zh") {
    params.set("lang", state.lang);
  }
  if (state.region !== "all") {
    params.set("region", state.region);
  }
  if (state.dynasty !== "all") {
    params.set("dynasty", state.dynasty);
  }
  if (state.search.trim()) {
    params.set("q", state.search.trim());
  }
  if (state.year !== "") {
    params.set("year", state.year);
  }
  const available = getAvailableCountries();
  const selected = getDisplayCountries();
  if (selected.length > 0 && selected.length !== available.length) {
    params.set("cols", selected.join(","));
  }

  if (state.panelCollapsed) {
    params.set("panel", "collapsed");
  } else if (window.matchMedia("(max-width: 980px)").matches) {
    params.set("panel", "expanded");
  }

  const query = params.toString();
  const next = query ? `${window.location.pathname}?${query}` : window.location.pathname;
  window.history.replaceState(null, "", next);
}
